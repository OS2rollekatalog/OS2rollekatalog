<!DOCTYPE html>
<html>
<head th:replace="fragments/header :: header (title=#{html.page.userroles.view.title})" />
<body>
	<div class="wrapper">
		<header th:replace="fragments/navbar :: navbar-header(subpage = 'roles')" />
		<aside th:replace="fragments/navbar :: navbar-aside (page = 'userroles.view', subpage = 'roles')" />
 
		<section>
			<div class="content-wrapper">
				<h3>
					<a th:href="@{/ui/userroles/list}" class="btn btn-default">
	                    <span><i class="fa fa-arrow-left"></i> </span>
	                </a>
					<span th:text="#{html.page.userroles.view.title}" />
				</h3>

				<div class="panel panel-default">
					<div class="panel-heading" />
					<div class="panel-body">
						<form class="form-horizontal" th:object="${role}">
							<fieldset>
								<div class="form-group">
					                <label class="col-sm-2 control-label" th:text="#{html.entity.userrole.name}" />
					                <div class="col-sm-8">
										<input th:field="*{name}" class="form-control" disabled="disabled" />
					                </div>
						        </div>
							</fieldset>

							<fieldset>
								<div class="form-group">
					                <label class="col-sm-2 control-label" th:text="#{html.entity.itsystem}" />
					                <div class="col-sm-8">
										<input th:field="*{itSystem.name}" class="form-control" disabled="disabled" />
					                </div>
						        </div>
							</fieldset>
							
							<fieldset>
								<div class="form-group">
					                <label class="col-sm-2 control-label" th:text="#{html.page.userroles.new.custom_identifier.label}" />
					                <div class="col-sm-8">
										<input th:field="*{identifier}" class="form-control" readonly />
					                </div>
						        </div>
							</fieldset>

							<fieldset>
								<div class="form-group">
									<label class="col-sm-2 control-label" th:text="#{html.entity.userrole.description}" />
									<div class="col-sm-8">
										<textarea th:field="*{description}" class="form-control" disabled="disabled" />
									</div>
								</div>
							</fieldset>

							<fieldset th:if="${role.linkedSystemRole != null}">
								<div class="form-group">
									<label class="col-sm-2 control-label" th:text="#{html.entity.userrole.linkedsystemrole}" />
									<div class="col-sm-8">
										<input th:field="*{linkedSystemRole.name}" class="form-control" readonly />
									</div>
								</div>
							</fieldset>

							<fieldset sec:authorize="hasRole('ROLE_REQUESTER')" th:if="${canRequest == true && @settingsService.getRequestApproveWho() == T(dk.digitalidentity.rc.service.model.WhoCanRequest).USERS}">
								<div class="form-group">
									<label class="col-sm-2 control-label" th:text="#{html.entity.view.action.label}" />
									<div class="col-sm-8">
										<a id="requestBtn" class="btn btn-lg btn-primary" th:text="#{html.entity.view.action.request}" />
									</div>
								</div>
							</fieldset>
							
							<fieldset sec:authorize="hasRole('ROLE_REQUESTER')" th:if="${canRequest && @settingsService.isRequestApproveEnabled() == true && @settingsService.getRequestApproveWho() == T(dk.digitalidentity.rc.service.model.WhoCanRequest).AUTHORIZATION_MANAGER}">
								<div class="form-group">
									<label class="col-sm-2 control-label" th:text="#{html.entity.view.action.label}" />
									<div class="col-sm-8">
										<a class="btn btn-lg btn-primary" th:text="#{html.entity.view.action.request}" th:href="@{/ui/requestapprove/request/step1/role/{id}?type=userRole(id=${role.id})}" />
									</div>
								</div>
							</fieldset>

							<fieldset sec:authorize="hasRole('ROLE_ADMINISTRATOR')" th:unless="${role.itSystem.readonly or role.linkedSystemRole != null}">
								<div class="form-group">
									<label class="col-sm-2 control-label"
										   th:text="#{html.entity.view.action.label}" />
									<div class="col-sm-8">
										<a th:href="@{/ui/userroles/edit/{id}(id=*{id})}">
											<span class="btn btn-lg btn-primary" th:text="#{html.entity.view.action.edit}" />
										</a>
									</div>
								</div>
							</fieldset>

							<ul class="nav nav-tabs">
								<li class="active">
									<a data-toggle="tab" href="#roles_menu" th:text="#{html.entity.userrole.systemroles}" />
								</li>

								<li>
									<a th:unless="${hideRolegroups}" data-toggle="tab" href="#rolegroups_menu" th:text="#{html.entity.userrole.rolegroupassignments}" />
								</li>

								<li>
									<a data-toggle="tab" href="#users_menu" th:text="#{html.entity.userrole.users}" />
								</li>

								<li>
									<a data-toggle="tab" href="#ous_menu" th:text="#{html.entity.userrole.orgunits}" />
								</li>
							</ul>

							<div class="tab-content">
								<div id="roles_menu" class="tab-pane fade in active">
									<table id="listTable1" class="table table-striped table-hover listTable">
										<thead>
										<tr>
											<th class="col-sm-4" th:text="#{html.entity.systemrole.type}"/>
											<th class="col-sm-8" th:text="#{html.entity.systemrole.constraints}"/>
										</tr>
										</thead>

										<tbody>
										<tr th:each="roleAssignment : *{systemRoleAssignments}">
											<td th:text="${roleAssignment.systemRole.name}" />
											<td th:utext="${T(dk.digitalidentity.rc.controller.mvc.xlsview.XlsUtil).stringifyAssignment(roleAssignment, true)}" />
										</tr>
										</tbody>
									</table>
								</div>

								<div th:unless="${hideRolegroups}" id="rolegroups_menu" class="tab-pane fade in">
									<table id="listTable4" class="table table-striped table-hover listTable">
										<thead>
										<tr>
											<th class="col-sm-4" th:text="#{html.entity.rolegroup.name}"/>
											<th class="col-sm-8" th:text="#{html.entity.rolegroup.description}"/>
										</tr>
										</thead>

										<tbody>
										<tr th:each="rolegroup : *{roleGroups}">
											<td th:text="${rolegroup.name}" />
											<td th:utext="${rolegroup.description}" />
										</tr>
										</tbody>
									</table>
								</div>

								<div id="users_menu" class="tab-pane fade in">
								</div>

								<div id="ous_menu" class="tab-pane fade in">
								</div>
							</div>
						</form>
					</div>
				</div>
	        </div>
	    </section>
    </div>
    
	<div class="modal fade" id="modal-request" role="dialog">
	    <div class="modal-dialog">
	        <div class="modal-content">
				<form class="form-horizontal" method="post" th:action="@{/ui/userroles/request}" th:object="${requestForm}">
					<input type="hidden" th:field="*{id}"/>
		            <div class="modal-header">
		                <h4 th:text="#{html.page.roles.request.modal.header}"/>
		            </div>
	
		            <div class="modal-body">
		            	<span th:text="#{html.page.roles.request.modal.body}"/>
						<textarea id="reasonField" required="required" oninvalid="this.setCustomValidity('Angiv begrundelse')" oninput="this.setCustomValidity('')" rows="8" class="form-control" th:field="*{reason}" style="margin-top: 10px;"></textarea>
		            </div>
		
					<div class="modal-footer">
						<button type="submit" class="btn btn-primary" th:text="#{html.control.button.request}"/>
						<button type="button" class="btn btn-danger" id="closeModalBtn" th:text="#{html.control.button.cancel}"/>
					</div>
				</form>
	        </div>
	    </div>
	</div>

	<style>
		.table .checkbox {
			margin-left: 10px;
			width: auto;
		}
	</style>

	<div id="ouUserRoleModal"></div>
	<div id="ouUserRoleEditModal"></div>
	<div th:replace="users/fragments/user_user_role_modal :: userUserRoleModal" />
	<div th:replace="users/fragments/role_assignment_edit_modal :: roleAssignmentEditModal" />
    <nav th:replace="fragments/footer :: footer" />

	<script th:replace="fragments/datatables :: datatables " />
	<script th:replace="fragments/assignDatePicker :: content " />
	<script th:replace="users/fragments/role_assignment_edit_modal :: roleAssignmentEditModalScript" />
	<script th:replace="users/fragments/user_user_role_modal :: userUserRoleModalScript(page='userrole')"/>
	<script th:replace="ous/fragments/ou_roles_modal :: ouRoleGroupModalScript(titlesEnabled=${titlesEnabled})" />
	<script th:replace="ous/fragments/ou_roles_edit_modal :: ouRolesEditModalScript(titlesEnabled=${titlesEnabled})" />
	
	<script th:inline="javascript">
		/*<![CDATA[*/
			
		/*[+
			var UIUrl = [[@{/ui/userroles/}]];
			var restUrl = [[@{/rest/userroles/}]];
			var userRestUrl = [[@{/rest/users/}]];
			var ouRestUrl = [[@{/rest/ous/}]];
			var roleId = [[${role.id}]];

			//Delete role assignment swal
			var deleteRoleAssignmentTitleTxt = [[#{html.page.manage.roles.delete.title}]];
			var deleteRoleAssignmentBodyTxt = [[#{html.page.manage.roles.delete.body}]];
			var deleteRoleAssignmentErrorMessage = [[#{html.page.manage.roles.delete.error}]];
			
			var deleteAssignmentConfirmTxt = [[#{html.control.button.yes}]];
			var deleteAssignmentCancelTxt = [[#{html.control.button.cancel}]];

			var titlesEnabled = [[${titlesEnabled}]];
			
			var infoMessage = [[${infoMessage}]];
			var errorMessage = [[${errorMessage}]];
		+]*/
		
		var token = $("meta[name='_csrf']").attr("content");
		var userService = new UserService();
		var orgUnitService = new OrgUnitService();
		var notificationService = new NotificationService();
		var modal = $("#modal-positions");

		$("document").ready(function() {
			userService.loadRolesFragment();
			userRoleModalService.parentService = userService;
			userRoleEditModalService.parentService = userService;
			
			orgUnitService.loadRolesFragment();
			ouRolesModalService.parentService = orgUnitService;
			ouRolesEditModalService.parentService = orgUnitService;

			$("#modal-request").on('shown.bs.modal', function() {
				$("#reasonField").focus();
			});
			
			$("#requestBtn").click(function() {
				$("#modal-request").modal({
				    backdrop: 'static',
				    keyboard: false
				});
			});
			
			$("#closeModalBtn").click(function() {
				$("#reasonField").val('');
				$("#modal-request").modal('hide');
			});
			
			if (infoMessage != null) {
				notificationService.showInfoNotification(infoMessage);
			}

			if (errorMessage != null) {
				notificationService.showErrorNotification(errorMessage);
			}
		});

		function UserService() {
			this.loadRolesFragment = function () {
				$("#users_menu").load(UIUrl + roleId + "/assignedUsersFragment", function () {
					fragShowDataTableFun('#listTableUsers', 0);
				});
			}
		}

		function OrgUnitService() {
			this.loadRolesFragment = function () {
				$("#ous_menu").load(UIUrl + roleId + "/assignedOrgUnitsFragment", function () {
					fragShowDataTableFun('#listTableOus', 0);
				});
			}
		}

		function NotificationService() {
			this.showInfoNotification = function(message) {
				$.notify({
					message: message,
					status: 'success',
					timeout: 2000
				});
			}
			
			this.showWarnNotification = function(message) {
				$.notify({
					message: message,
					status: 'warning',
					timeout: 3000
				});
			}

			this.showErrorNotification = function(message) {
				$.notify({
					message: message,
					status: 'danger',
					timeout: 4000
				});
			}
		}
		/*]]>*/
	</script>
</body>
</html>
