<!DOCTYPE html>
<html>
<head th:replace="fragments/header :: header (title=#{html.page.rolegroup.edit.title})"></head>
<body>
	<div class="wrapper">
	    <header th:replace="fragments/navbar :: navbar-header(subpage = 'roles')"></header>
	    <aside th:replace="fragments/navbar :: navbar-aside (page = 'users_request', subpage = 'roles')"></aside>
	    <section>
	        <div class="content-wrapper">
	            <div class="panel panel-default">
	                <div class="panel-body">
	                	<p th:text="#{html.page.requestapprove.list_roles.text(${user.name})}"></p>

						<table id="listTable1" class="table table-striped table-hover listTable">
							<thead>
								<tr>
									<th class="col-md-2" th:text="#{html.entity.user.name}"></th>
									<th class="col-md-2" th:text="#{html.entity.itsystem}"></th>
									<th class="col-md-5" th:text="#{html.entity.userrole.description}"></th>
									<th class="col-md-2" th:text="#{html.page.users.manage.assignment.type}"></th>
									<th class="col-md-1">Anmod</th>
								</tr>
							</thead>

							<tbody>
								 <tr th:each="role : ${roles}">
									<td th:text="${role.name}"></td>
									<td th:text="${role.itSystemName}"></td>
									<td th:text="${role.description}"></td>
									<td th:if="${#strings.equals(role.type, 'userRole')}" th:text="#{html.role.assignment.type.userrole}"></td>
								 	<td th:unless="${#strings.equals(role.type, 'userRole')}" th:text="#{html.role.assignment.type.rolegroup}"></td>
								 	<td>
										<a th:if="${#strings.equals(role.type, 'userRole')}" class="requestUserRoleBtn" th:attr="data-id=${role.id}, data-type=${role.type}" ><em class="fa fa-plus"></em></a>
										<a th:unless="${#strings.equals(role.type, 'userRole')}" class="requestRoleGroupBtn" th:attr="data-id=${role.id}, data-type=${role.type}" ><em class="fa fa-plus"></em></a>
									</td>
								</tr>
							</tbody>
						</table>
	                </div>
	            </div>
	        </div>
	    </section>
	</div>

	<div class="modal fade" id="modal-request-user-role" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<form class="form-horizontal" method="post" th:action="@{/ui/userroles/request}" th:object="${requestForm}">
					<input type="hidden" id="userUuidUR" th:field="*{userUuid}"/>
					<input type="hidden" id="roleIdUR" th:field="*{roleId}"/>
					<div class="modal-header">
						<h4 th:text="#{html.page.roles.request.modal.header}"></h4>
					</div>

					<div class="modal-body">
						<span th:text="#{html.page.roles.request.modal.body}"></span>
						<textarea id="reasonFieldUR" required="required" oninvalid="this.setCustomValidity('Angiv begrundelse')" oninput="this.setCustomValidity('')" rows="8" class="form-control" th:field="*{reason}" style="margin-top: 10px;"></textarea>
					</div>

					<div class="modal-footer">
						<button type="button" onclick="requestUserRole();" class="btn btn-primary" th:text="#{html.control.button.request}"></button>
						<button type="button" class="btn btn-danger" id="closeModalBtnUR" th:text="#{html.control.button.cancel}"></button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<div class="modal fade" id="modal-request-role-group" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<form class="form-horizontal" method="post" th:action="@{/ui/rolegroups/request}" th:object="${requestForm}">
					<input type="hidden" id="userUuidRG" th:field="*{userUuid}"/>
					<input type="hidden" id="roleIdRG" th:field="*{roleId}"/>
					<div class="modal-header">
						<h4 th:text="#{html.page.roles.request.modal.header}"></h4>
					</div>

					<div class="modal-body">
						<span th:text="#{html.page.roles.request.modal.body}"></span>
						<textarea id="reasonFieldRG" required="required" oninvalid="this.setCustomValidity('Angiv begrundelse')" oninput="this.setCustomValidity('')" rows="8" class="form-control" th:field="*{reason}" style="margin-top: 10px;"></textarea>
					</div>

					<div class="modal-footer">
						<button type="button" onclick="requestRoleGroup();" class="btn btn-primary" th:text="#{html.control.button.request}"></button>
						<button type="button" class="btn btn-danger" id="closeModalBtnRG" th:text="#{html.control.button.cancel}"></button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<nav th:replace="fragments/footer :: footer"></nav>
	<script th:replace="fragments/datatables :: datatables"></script>

	<script th:inline="javascript">
		/*<![CDATA[*/
			
			/*[+
				var orgUnitUuid = [[${orgUnitUuid}]];
				var url = [[@{/rest/requestapprove/request/role}]];
				var redirectUri = [[@{/ui/my/requests}]];
				var fieldNotUpdatedMsg = [[#{html.entity.rolegroup.failedupdatemsg}]];
			+]*/

			var token = $("meta[name='_csrf']").attr("content");

			function requestUserRole() {
				var reason = $('#reasonFieldUR').val();
				var selectedUsers = [$('#userUuidUR').val()];
				var roleId = $('#roleIdUR').val();
				var roleType = 'userRole';
				
				call(reason, selectedUsers, roleId, roleType);
										
				$("#modal-request-user-role").modal('hide');
			}
			
			function requestRoleGroup() {
				var reason = $('#reasonFieldRG').val();
				var selectedUsers = [$('#userUuidRG').val()];
				var roleId = $('#roleIdRG').val();
				var roleType = 'roleGroup';
				
				call(reason, selectedUsers, roleId, roleType);
										
				$("#modal-request-user-role").modal('hide');
			}
			
			function call(reason, selectedUsers, roleId, roleType) {
				$.ajax({
					url: url,
					method: 'POST',
			        headers: {
			            'X-CSRF-TOKEN': token
			        },
			        contentType: "application/json",
			        data: JSON.stringify({
					   "reason" : reason,
					   "selectedUsers" : selectedUsers,
					   "roleId" : roleId,
					   "roleType" : roleType,
					   "orgUnitUuid" : orgUnitUuid
					}),
					error: function(response) {
	    				$.notify({
	    					message: fieldNotUpdatedMsg
	    				},{
	    					status: 'danger',
	    					autoHideDelay: 4000
	    				});
	    			},
	    			success: function(response) {
    					window.location.href = redirectUri;
	    			}
				});
			}
		
			$("document").ready(function() {
				// add listeners initially
				$(".requestUserRoleBtn").click(function() {
					$("#roleIdUR").val($(this).data("id"));
					$("#modal-request-user-role").modal({
						backdrop: 'static',
						keyboard: false
					});
				});

				$(".requestRoleGroupBtn").click(function() {
					$("#roleIdRG").val($(this).data("id"));
					$("#modal-request-role-group").modal({
						backdrop: 'static',
						keyboard: false
					});
				});

				// add listeners on table draw
				$('#listTable1').on('draw.dt', function() {
					$('.requestUserRoleBtn').off('click');
					$(".requestUserRoleBtn").click(function() {
						$("#roleIdUR").val($(this).data("id"));
						$("#modal-request-user-role").modal({
							backdrop: 'static',
							keyboard: false
						});
					});

					$('.requestRoleGroupBtn').off('click');
					$(".requestRoleGroupBtn").click(function() {
						$("#roleIdRG").val($(this).data("id"));
						$("#modal-request-role-group").modal({
							backdrop: 'static',
							keyboard: false
						});
					});
				});

				// user role modal
				$("#modal-request-user-role").on('shown.bs.modal', function() {
					$("#reasonFieldUR").focus();
				});

				$("#closeModalBtnUR").click(function() {
					$("#reasonFieldUR").val('');
					$("#modal-request-user-role").modal('hide');
				});

				// role group modal
				$("#modal-request-role-group").on('shown.bs.modal', function() {
					$("#reasonFieldRG").focus();
				});

				$("#closeModalBtnRG").click(function() {
					$("#reasonFieldRG").val('');
					$("#modal-request-role-group").modal('hide');
				});
			});
			
		/*]]>*/
	</script>
</body>
</html>
