<!DOCTYPE html>
<html>
<head th:replace="fragments/header :: header (title=#{html.page.rolegroup.view.title})" />
<body>
	<div class="wrapper">
		<header th:replace="fragments/navbar :: navbar-header(subpage = 'roles')" />
		<aside th:replace="fragments/navbar :: navbar-aside (page = 'rolegroups.new', subpage = 'roles')" />
 
		<section>
			<div class="content-wrapper">
				<h3>
	                <a th:href="@{/ui/rolegroups/list}" class="btn btn-default">
	                    <span><i class="fa fa-arrow-left"></i> </span>
	                </a>
					<span th:text="#{html.page.rolegroup.view.title}" />
				</h3>

				<div class="panel panel-default">
					<div class="panel-heading" />
					<div class="panel-body">
						<form class="form-horizontal" th:object="${rolegroup}">
							<fieldset>
								<div class="form-group">
					                <label class="col-sm-2 control-label" th:text="#{html.entity.rolegroup.name}" />
					                <div class="col-sm-8">
										<input th:field="${rolegroup.name}" class="form-control" disabled="disabled" />
					                </div>
						        </div>
							</fieldset>

							<fieldset>
								<div class="form-group">
									<label class="col-sm-2 control-label" th:text="#{html.entity.rolegroup.description}" />
									<div class="col-sm-8">
										<textarea th:field="${rolegroup.description}" class="form-control" disabled="disabled" />
									</div>
								</div>
							</fieldset>

							<fieldset sec:authorize="hasRole('ROLE_REQUESTER')" th:if="${canRequest && @settingsService.getRequestApproveWho() == T(dk.digitalidentity.rc.service.model.WhoCanRequest).USERS}">
								<div class="form-group">
									<label class="col-sm-2 control-label" th:text="#{html.entity.view.action.label}" />
									<div class="col-sm-8">
										<a id="requestBtn" class="btn btn-lg btn-primary" th:text="#{html.entity.view.action.request}" />
									</div>
								</div>
							</fieldset>
							
							<fieldset sec:authorize="hasRole('ROLE_REQUESTER')" th:if="${canRequest && @settingsService.getRequestApproveWho() == T(dk.digitalidentity.rc.service.model.WhoCanRequest).AUTHORIZATION_MANAGER}">
								<div class="form-group">
									<label class="col-sm-2 control-label" th:text="#{html.entity.view.action.label}" />
									<div class="col-sm-8">
										<a class="btn btn-lg btn-primary" th:text="#{html.entity.view.action.request}" th:href="@{/ui/requestapprove/request/step1/role/{id}?type=roleGroup(id=${rolegroup.id})}" />
									</div>
								</div>
							</fieldset>

							<fieldset sec:authorize="hasRole('ROLE_ADMINISTRATOR')">
								<div class="form-group">
									<label class="col-sm-2 control-label" th:text="#{html.entity.view.action.label}" />
									
									<div class="col-sm-8">
										<a th:href="@{/ui/rolegroups/edit/{id}(id=${rolegroup.id})}">
											<span class="btn btn-lg btn-primary" th:text="#{html.entity.view.action.edit}" />
										</a>
									</div>
								</div>
							</fieldset>
						</form>

						<ul class="nav nav-tabs">
						  	<li class="active">
								<a data-toggle="tab" href="#roles_menu" th:text="#{html.page.rolegroup.list.roles}"></a>
							</li>
							
							<li>
								<a data-toggle="tab" href="#users_menu" th:text="#{html.entity.userrole.users}" />
							</li>
							
							<li>
								<a data-toggle="tab" href="#ous_menu" th:text="#{html.entity.userrole.orgunits}" />
							</li>
						</ul>

						<div class="tab-content">
							<div id="roles_menu" class="tab-pane fade in active">
								<table id="listTable" class="table table-striped table-hover listTable">
									<thead>
										<tr>
											<th class="col-md-3" th:text="#{html.entity.rolegroup.name}" />
											<th class="col-md-3" th:text="#{html.entity.rolegroup.itsystem}" />
											<th class="col-md-6" th:text="#{html.entity.rolegroup.description}" />
										</tr>
									</thead>				
									<tbody>
									    <tr th:each="assignment : ${rolegroup.userRoleAssignments}">
									    	<td th:text="${assignment.userRole.name}" />	
									    	<td th:text="${assignment.userRole.itSystem.name}" />											    	
									    	<td th:text="${assignment.userRole.description}" />										    	
						    			</tr>
					    			</tbody>
								</table>
							</div>

							<div id="users_menu" class="tab-pane fade in">
							</div>

							<div id="ous_menu" class="tab-pane fade in">
							</div>
						</div>
					</div>
				</div>
	        </div>
	    </section>
    </div>

	<div class="modal fade" id="modal-request" role="dialog">
	    <div class="modal-dialog">
	        <div class="modal-content">
				<form class="form-horizontal" method="post" th:action="@{/ui/rolegroups/request}" th:object="${requestForm}">
					<input type="hidden" th:field="*{id}"/>
		            <div class="modal-header">
		                <h4 th:text="#{html.page.roles.request.modal.header}"/>
		            </div>
	
		            <div class="modal-body">
		            	<span th:text="#{html.page.roles.request.modal.body}"/>
						<textarea id="reasonField" required="required" oninvalid="this.setCustomValidity('Angiv begrundelse')" oninput="this.setCustomValidity('')" rows="8" class="form-control" th:field="*{reason}" style="margin-top: 10px;"></textarea>
		            </div>
		
					<div class="modal-footer">
						<button type="submit" class="btn btn-primary" th:text="#{html.control.button.request}"/>
						<button type="button" class="btn btn-danger" id="closeModalBtn" th:text="#{html.control.button.cancel}"/>
					</div>
				</form>
	        </div>
	    </div>
	</div>

	<div id="userRoleGroupModal"></div>
	<div id="ouRoleGroupModal"></div>
	<div id="ouRoleGroupEditModal"></div>
	<div th:replace="users/fragments/role_assignment_edit_modal :: roleAssignmentEditModal" />
	<nav th:replace="fragments/footer :: footer"/>
	
	<script th:replace="fragments/datatables :: datatables(orderColumnValue=1) " />
	<script th:replace="fragments/assignDatePicker :: content " />
	
	<script th:replace="ous/fragments/ou_roles_modal :: ouRoleGroupModalScript(titlesEnabled=${titlesEnabled})" />
	<script th:replace="ous/fragments/ou_roles_edit_modal :: ouRolesEditModalScript(titlesEnabled=${titlesEnabled})" />
	<script th:replace="users/fragments/role_assignment_edit_modal :: roleAssignmentEditModalScript" />
	<script th:replace="users/fragments/user_role_group_modal :: userRoleGroupModalScript"/>
	
	<script th:inline="javascript">
		/*<![CDATA[*/
			
		/*[+
			var url = [[@{/rest/rolegroups/}]];
			var roleId = [[${rolegroup.id}]];
			var fieldUpdatedMsg = [[#{html.entity.rolegroup.updatedmsg}]];
			var fieldNotUpdatedMsg = [[#{html.entity.rolegroup.failedupdatemsg}]];

			var UIUrl = [[@{/ui/rolegroups/}]];
			var userRestUrl = [[@{/rest/users/}]];
			var ouRestUrl = [[@{/rest/ous/}]];
			
			//Delete role assignment swal
			var deleteRoleAssignmentTitleTxt = [[#{html.page.manage.roles.delete.title}]];
			var deleteRoleAssignmentBodyTxt = [[#{html.page.manage.roles.delete.body}]];
			var deleteRoleAssignmentErrorMessage = [[#{html.page.manage.roles.delete.error}]];
			
			var deleteAssignmentConfirmTxt = [[#{html.control.button.yes}]];
			var deleteAssignmentCancelTxt = [[#{html.control.button.cancel}]];
			
			var titlesEnabled = [[${titlesEnabled}]];
			var roleId = [[${rolegroup.id}]];
				
			var infoMessage = [[${infoMessage}]];
			var errorMessage = [[${errorMessage}]];
		+]*/

		var token = $("meta[name='_csrf']").attr("content");
		
		var userService = new UserService();
		var orgUnitService = new OrgUnitService();
		var notificationService = new NotificationService();
		
		$("document").ready(function() {
			userService.loadRolesFragment();
			//Edit RoleGroup assignemnet on User modal
			userRoleEditModalService.parentService = userService;
			
			orgUnitService.loadRolesFragment();
			//Edit RoleGroup assignmnet on OrgUnit modal
			ouRolesEditModalService.parentService = orgUnitService;

			$("#modal-request").on('shown.bs.modal', function() {
				$("#reasonField").focus();
			});
			
			$("#requestBtn").click(function() {
				$("#modal-request").modal({
				    backdrop: 'static',
				    keyboard: false
				});
			});
			
			$("#closeModalBtn").click(function() {
				$("#reasonField").val('');
				$("#modal-request").modal('hide');
			});
			
			if (infoMessage != null) {
				notificationService.showInfoNotification(infoMessage);
			}

			if (errorMessage != null) {
				notificationService.showErrorNotification(errorMessage);
			}
		});

		function UserService() {
			this.loadRolesFragment = function () {
				$("#users_menu").load(UIUrl + roleId + "/assignedUsersFragmentView", function () {
					fragShowDataTableFun('#listTableUsers', 0);
				});
			}
		}

		function OrgUnitService() {
			this.loadRolesFragment = function () {
				$("#ous_menu").load(UIUrl + roleId + "/assignedOrgUnitsFragment", function () {
					fragShowDataTableFun('#listTableOus', 0);
				});
			}
		}
		
		function NotificationService() {
			this.showInfoNotification = function(message) {
				$.notify({
					message: message,
					status: 'success',
					timeout: 2000
				});
			}
			
			this.showWarnNotification = function(message) {
				$.notify({
					message: message,
					status: 'warning',
					timeout: 3000
				});
			}

			this.showErrorNotification = function(message) {
				$.notify({
					message: message,
					status: 'danger',
					timeout: 4000
				});
			}
		}
		/*]]>*/
	</script>
</body>
</html>
