<!DOCTYPE html>
<html>
<head th:replace="fragments/header :: header (title=#{html.page.rolegroup.edit.title})" />
<body>
<div class="wrapper">
    <header th:replace="fragments/navbar :: navbar-header" />
    <aside th:replace="fragments/navbar :: navbar-aside (page = 'rolegroups.list')" />
    <section>
        <div class="content-wrapper">
            <h3>
                <a th:href="@{/ui/rolegroups/list}" class="btn btn-default">
                    <span><i class="fa fa-arrow-left"></i> </span>
                </a>
                <span th:text="#{html.page.rolegroup.edit.title}"/>
            </h3>

            <div class="panel panel-default">
                <div class="panel-heading"/>
                <div class="panel-body">
                    <form class="form-horizontal" th:object="${rolegroup}">
                        <input th:field="*{id}" type="hidden"/>

                        <fieldset>
                            <div class="form-group">
                                <label class="col-sm-2 control-label" th:text="#{html.entity.rolegroup.name}"/>
                                <div class="col-sm-8">
                                    <input th:field="*{name}" class="form-control" />
                                    <ul th:if="${#fields.hasErrors('name')}">
                                        <li th:each="err : ${#fields.errors('name')}" th:text="${err}"/>
                                    </ul>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <div class="form-group">
                                <label class="col-sm-2 control-label" th:text="#{html.entity.rolegroup.description}"/>
                                <div class="col-sm-8">
                                    <textarea th:field="${rolegroup.description}" class="form-control" />
                                </div>
                            </div>
                        </fieldset>
                        
						<fieldset>
							<div class="form-group">
								<label class="col-sm-2 control-label" th:text="#{html.role.flag.useronly}" />
								<div class="col-sm-1">
									<div class="checkbox c-checkbox">
										<label>
											<input class="useronly-checkbox" type="checkbox" data-flag="useronly" th:attr="checked=${rolegroup.userOnly}" />
											<span class="fa fa-check"></span>
										</label>
									</div>
								</div>

								<label class="col-sm-2 control-label" th:text="#{html.role.flag.inherit}" />
								<div class="col-sm-1">
									<div class="checkbox c-checkbox">
										<label>
											<input class="inherit-checkbox" type="checkbox" data-flag="inherit" th:attr="checked=${rolegroup.ouInheritAllowed}" />
											<span class="fa fa-check"></span>
										</label>
									</div>
								</div>
								
								<label class="col-sm-2 control-label" th:text="#{html.role.flag.canrequest}" />
								<div class="col-sm-1">
									<div class="checkbox c-checkbox">
										<label>
											<input class="canrequest-checkbox" type="checkbox" data-flag="canrequest" th:attr="checked=${rolegroup.canRequest}" />
											<span class="fa fa-check"></span>
										</label>
									</div>
								</div>
							</div>
						</fieldset>
                    </form>

                    <table id="listTable" class="table table-striped table-hover listTable">
                        <thead>
                        <tr>
                            <th class="col-md-1" th:text="#{html.entity.rolegroup.enabled}"/>
                            <th class="col-md-5" th:text="#{html.entity.rolegroup.name}"/>
                            <th class="col-md-3" th:text="#{html.entity.rolegroup.itsystem}"/>
                            <th class="col-md-3" th:text="#{html.entity.rolegroup.description}"/>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:each="addRole : ${roles}">
							<td>
								<div>
									<div class="checkbox c-checkbox">
										<label>
											<input class="checkboxaction" th:id="${addRole.role.id}" type="checkbox"
													th:value="${rolegroup.id}" th:checked="${addRole.checked}"
														data-objtype="role"/>
												<span class="fa fa-check"></span>
										</label>
									</div>
								</div>
							</td>
                            <td th:text="${addRole.role.name}"/>
                            <td th:text="${addRole.role.itSystem.name}"/>
                            <td th:text="${addRole.role.description}"/>
                        </tr>
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </section>
</div>

	<style>
		.table .checkbox {
			margin-left: 10px;
			width: auto;
		}
	</style>

	<nav th:replace="fragments/footer :: footer"/>
	<script th:replace="fragments/datatables :: datatables " />

	<script th:inline="javascript">
		/*<![CDATA[*/
			$("document").ready( function() {
				/*[+
					var url = [[@{/rest/rolegroups/}]];
					var roleId = [[${rolegroup.id}]];
					var fieldUpdatedMsg = [[#{html.entity.rolegroup.updatedmsg}]];
					var fieldNotUpdatedMsg = [[#{html.entity.rolegroup.failedupdatemsg}]];
				+]*/

				var token = $("meta[name='_csrf']").attr("content");

				$("#name").change(handleChangeOnInput);
				$("#description").change(handleChangeOnInput);
				
				$('.useronly-checkbox').change(flagCheckboxChange);
				$('.inherit-checkbox').change(flagCheckboxChange);
				$('.canrequest-checkbox').change(flagCheckboxChange);
				
				function addCheckboxListeners() {
					$('.checkboxaction').off("change");
					$('.checkboxaction').change(handleCheckboxChange);
				}

				addCheckboxListeners();

				$('#listTable').on( 'draw.dt', function () {
					addCheckboxListeners();
				});

				function handleChangeOnInput() {
					var objId = $("#id").val();
					var objName = $("#name").val();
					var objDescription = $("#description").val();
					
					var roleGroup = {
						id: objId,
						name: objName,
						description: objDescription
					};

					$.ajax({
						url: url + 'edit',
						method: 'POST',
				        headers: {
				            'X-CSRF-TOKEN': token
				        },
						data: roleGroup,
						error: function(response) {
		    				$.notify({
		    					message: fieldNotUpdatedMsg
		    				},{
		    					status: 'danger',
		    					autoHideDelay: 4000
		    				});
		    			},
		    			success: function(response) {
		    				$.notify({
		    					message: fieldUpdatedMsg
		    				},{
		    					status: 'success',
		    					autoHideDelay: 2000
		    				});
		    			}
					});
				};

				function getAjaxObject(urL, okMsg, errorMsg){
		    		return {
		    			url: urL,
						method: 'POST',
				        headers: {
				            'X-CSRF-TOKEN': token
				        },
		    			error: function(response) {
		    				$.notify({
		    					message: errorMsg
		    				},{
		    					status: 'danger',
		    					autoHideDelay: 4000
		    				});
		    			},
		    			success: function(response) {
		    				$.notify({
		    					message: okMsg
		    				},{
		    					status: 'success',
		    					autoHideDelay: 2000
		    				});
		    			}
		    		}
		    	};

				function handleCheckboxChange() {		
					var objType = String(this.dataset.objtype)
					if (this.checked) {
						$.ajax(getAjaxObject(url + 'add' + objType + '/' + this.value + '/' + this.id,fieldUpdatedMsg, fieldNotUpdatedMsg));
					}
					else {
						$.ajax(getAjaxObject(url + 'remove' + objType + '/' + this.value + '/' + this.id,fieldUpdatedMsg, fieldNotUpdatedMsg));
					}
				}
				
				function flagCheckboxChange() {
					var flag = String(this.dataset.flag);
					var updateUrl = url + "flag/" + roleId + "/" + flag;

					if (this.checked) {
						updateUrl = updateUrl + "?active=true";
					}
					else {
						updateUrl = updateUrl + "?active=false";
					}
					
					$.ajax({
						url: updateUrl,
						method: "POST",
						headers: {
							'X-CSRF-TOKEN': token
						},
						error: function(response) {
							$.notify({
								message: response.responseText
							}, {
								status: 'danger',
								autoHideDelay: 4000
							});
						},
						success: function(response) {	
							$.notify({
								message: fieldUpdatedMsg
							}, {
								status: 'success',
								autoHideDelay: 2000
							});
						}
					});
				}
			});
		/*]]>*/
	</script>
</body>
</html>
