<!DOCTYPE html>
<html>
<head th:replace="fragments/header :: header (title=#{html.page.ous.edit.title})" />
<body>
	<div class="wrapper">
		<header th:replace="fragments/navbar :: navbar-header" />
		<aside th:replace="fragments/navbar :: navbar-aside (page = 'ous')" />
		
		<section>
			<div class="content-wrapper">
				<h3>
					<a th:href="@{/ui/ous/list}" class="btn btn-default">
						<span>
							<i class="fa fa-arrow-left"></i>
						</span>
					</a>
					<span th:text="#{html.page.ous.edit.title}"></span>
				</h3>

				<div class="panel panel-default">
					<div class="panel-heading"></div>
					<div class="panel-body">
						<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
							<div class="panel panel-default">
								<div class="panel-heading" role="tab" id="stamdataHeading">
									<h4 class="panel-title">
										<a role="button" id="stamdataLink" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
											<em id="caretIcon" class="fa fa-caret-right"></em>&nbsp;
											<span th:text="#{html.heading.stamdata}"></span>
											<span th:text="${ou.name}"></span>
										</a>
									</h4>
								</div>

								<div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="stamdataHeading">
									<div class="panel-body">
										<form class="form-horizontal" th:object="${ou}">
											<fieldset>
												<div class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.entity.ou.name}" />
													<div class="col-sm-8">
														<input th:field="${ou.name}" class="form-control" disabled="disabled" />
													</div>
												</div>
											</fieldset>

											<fieldset sec:authorize="hasRole('ROLE_ADMINISTRATOR')">
												<div th:if="${@roleCatalogueConfiguration.getOrganisation().isGetLevelsFromApi() == false}" class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.entity.ou.level}" />
													<div class="col-sm-8">
														<select onchange="setLevel(this);" class="form-control">
															<option th:each="level : ${allowedLevels}"
																th:value="${level}" th:text="#{__${level.message}__}"
																th:selected="${level} == *{level}"></option>
														</select>
													</div>
												</div>
												
												<div th:if="${@roleCatalogueConfiguration.getOrganisation().isGetLevelsFromApi() == true}" class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.entity.ou.level}" />
													<div class="col-sm-8">
														<input th:value="#{__${ou.level.message}__}" class="form-control" disabled="disabled" />
													</div>
												</div>
											</fieldset>
														
											<fieldset sec:authorize="!hasRole('ROLE_ADMINISTRATOR')">
												<div class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.entity.ou.level}" />
													<div class="col-sm-8">
														<input th:value="#{__${ou.level.message}__}" class="form-control" disabled="disabled" />
													</div>
												</div>
											</fieldset>

											<fieldset>
												<div class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.entity.ou.manager}" />
													<div class="col-sm-8">
														<input th:value="${ou.manager} != null ? ${ou.manager.name} : ''" class="form-control" disabled="disabled" />
													</div>
												</div>
											</fieldset>
											
											<fieldset th:if="${kleUiEnabled == true}" sec:authorize="hasRole('ROLE_KLE_ADMINISTRATOR')">
												<div class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.orgunit.settings}"></label>
													<div class="col-sm-8">
														<div class="checkbox c-checkbox">
															<label>
																<input class="inherit-checkbox" type="checkbox" data-flag="inherit" th:attr="checked=${ou.inheritKle}"/>
																<span class="fa fa-check"></span>
															</label>
															
															<label th:text="#{html.orgunit.flag.inherit}"></label>
														</div>
													</div>
												</div>
												
												<div class="form-group" th:if="${#lists.size(parentsKleIsInheritedFrom)} > 0">
													<div class="col-sm-offset-2 col-sm-8" style="margin-top: 20px;">
														<span style="font-weight: bold;" th:text="#{html.orgunit.kle.inherited.from}" />
														<ul>
															<li th:each="ouInheritedFrom : ${parentsKleIsInheritedFrom}" th:text="${ouInheritedFrom.name}" />
														</ul>
													</div>
												</div>
											</fieldset>
										</form>
									</div>
								</div>
							</div>
						</div>

						<ul class="nav nav-tabs" id="dataTabs">
							<li th:class="${!onlyKleAdmin} ? active : ''" sec:authorize="hasRole('ROLE_ASSIGNER')">
								<a data-toggle="tab" href="#roles_menu" th:text="#{html.page.ous.list.roles}"></a>
							</li>

							<li sec:authorize="hasRole('ROLE_ASSIGNER')">
								<a data-toggle="tab" href="#groups_menu" th:text="#{html.page.ous.list.rolegroups}"></a>
							</li>

							<li th:class="${onlyKleAdmin} ? active : ''" th:if="${kleUiEnabled == true}" sec:authorize="hasRole('ROLE_KLE_ADMINISTRATOR')">
								<a data-toggle="tab" id="kleFirstTab" href="#kle_performing_menu" th:text="#{html.page.ous.list.kleperform}"></a>
							</li>
							
							<li th:if="${kleUiEnabled == true}" sec:authorize="hasRole('ROLE_KLE_ADMINISTRATOR')">
								<a data-toggle="tab" href="#kle_insight_menu" th:text="#{html.page.ous.list.kleinterest}"></a>
							</li>

							<li>
								<a data-toggle="tab" href="#users_menu" th:text="#{html.page.ous.list.users}"></a>
							</li>
						</ul>

						<div class="tab-content">
							<div id="roles_menu" th:class="${!onlyKleAdmin} ? 'tab-pane fade in active' : 'tab-pane fade'">
								<table id="listTable1" class="table table-striped table-hover listTable">
									<thead>
										<tr>
											<th class="col-md-1" th:text="#{html.entity.rolegroup.enabled}" />
											<th class="col-md-2" th:text="#{html.entity.rolegroup.name}" />
											<th class="col-md-2" th:text="#{html.entity.rolegroup.itsystem}" />
											<th class="col-md-2" th:text="#{html.entity.rolegroup.validity}"/>
											<th class="col-md-1" th:text="#{html.entity.title.count}" />
											<th class="col-md-4" th:text="#{html.entity.rolegroup.description}" />
										</tr>
									</thead>

									<tbody>
										<tr th:each="addRole : ${addRoles}" th:id="${addRole.role.id}+'roleRow'" th:attr="data-ou=${addRole.ouAssignment}">
											<td>
												<div class="checkbox c-checkbox">
													<label>
														<input th:id="${addRole.role.id}" type="checkbox" th:checked="${addRole.checked}" class="checkboxaction" 
																th:attr="data-inherit=${addRole.role.ouInheritAllowed}, data-startdate=${addRole.assignment.startDate}, data-stopdate=${addRole.assignment.stopDate}" data-objtype="role"/>
														<span class="fa fa-check"></span>
													</label>
												</div>
												<label th:id="${addRole.role.id}+'sortLabel'" style="display:none" th:text="${addRole.checked}"/>
											</td>
											<td th:text="${addRole.role.name}" />
											<td th:text="${addRole.role.itSystem.name}" />

		                                    <td class="fromToDate">
		                                    	<ul th:if="${addRole.assignment.startDate != null or addRole.assignment.stopDate != null}" style="padding-left: 0px; list-style-type: none;">
			                                    	<li th:if="${addRole.assignment.startDate != null}" th:text="#{html.word.assigned} + ' ' + ${addRole.assignment.startDate}"></li>
			                                    	<li th:if="${addRole.assignment.stopDate != null}" th:text="#{html.word.deassigned} + ' ' + ${addRole.assignment.stopDate}"></li>
		                                    	</ul>
		                                    	<span th:if="${addRole.checked == true and addRole.assignment.startDate == null and addRole.assignment.stopDate == null}" th:text="#{html.word.indefinite}"/>
		                                    </td>
											
											<th:block th:switch="${addRole.assignmentType}">
												<td th:case="-2" th:text="#{html.entity.ou.assigned.inherit}" />
												<td th:case="-1" th:text="#{html.entity.ou.assigned.all}" />
												<td th:case="0"></td>
												<td th:case="1" th:text="#{html.entity.ou.assigned.one}" />
												<td th:case="*" th:text="#{html.entity.ou.assigned.many(${addRole.assignmentType})}" />
											</th:block>

											<td th:text="${addRole.role.description}" />
										</tr>
									</tbody>
								</table>
							</div>

							<div id="groups_menu" class="tab-pane fade">
								<table id="listTable2" class="table table-striped table-hover listTable">
									<thead>
										<tr>
											<th class="col-md-1" th:text="#{html.entity.rolegroup.enabled}" />
											<th class="col-md-2" th:text="#{html.entity.rolegroup.name}" />
											<th class="col-md-2" th:text="#{html.entity.rolegroup.validity}"/>
											<th class="col-md-1" th:text="#{html.entity.title.count}" />
											<th class="col-md-6" th:text="#{html.entity.rolegroup.description}" />
										</tr>
									</thead>

									<tbody>
										<tr th:each="addRolegroup : ${addRoleGroups}" th:id="${addRolegroup.roleGroup.id}+'roleGroupRow'" th:attr="data-inherit=${addRolegroup.checkedWithInherit}">
											<td>
												<div class="checkbox c-checkbox">
													<label>
														<input th:id="${addRolegroup.roleGroup.id}" type="checkbox" th:checked="${addRolegroup.checked}" class="checkboxaction" 
																th:attr="data-inherit=${addRolegroup.roleGroup.ouInheritAllowed}, data-startdate=${addRolegroup.assignment.startDate},data-stopdate=${addRolegroup.assignment.stopDate}" data-objtype="rolegroup" />
														<span class="fa fa-check"></span>
													</label>
												</div>
												<label th:id="${addRolegroup.roleGroup.id}+'groupSortLabel'" style="display:none" th:text="${addRolegroup.checked}"/>
											</td>
											<td th:text="${addRolegroup.roleGroup.name}" />

		                                    <td class="fromToDate">
		                                    	<ul th:if="${addRolegroup.assignment.startDate != null or addRolegroup.assignment.stopDate != null}" style="padding-left: 0px; list-style-type: none;">
			                                    	<li th:if="${addRolegroup.assignment.startDate != null}" th:text="#{html.word.assigned} + ' ' + ${addRolegroup.assignment.startDate}"></li>
			                                    	<li th:if="${addRolegroup.assignment.stopDate != null}" th:text="#{html.word.deassigned} + ' ' + ${addRolegroup.assignment.stopDate}"></li>
		                                    	</ul>
		                                    	<span th:if="${addRolegroup.checked == true and addRolegroup.assignment.startDate == null and addRolegroup.assignment.stopDate == null}" th:text="#{html.word.indefinite}"/>
		                                    </td>

											<th:block th:switch="${addRolegroup.assignmentType}">
												<td th:case="-2" th:text="#{html.entity.ou.assigned.inherit}" />
												<td th:case="-1" th:text="#{html.entity.ou.assigned.all}" />
												<td th:case="0"></td>
												<td th:case="1" th:text="#{html.entity.ou.assigned.one}" />
												<td th:case="*" th:text="#{html.entity.ou.assigned.many(${addRolegroup.assignmentType})}" />
											</th:block>

											<td th:text="${addRolegroup.roleGroup.description}" />
										</tr>
									</tbody>
								</table>
							</div>

							<div sec:authorize="hasRole('ROLE_KLE_ADMINISTRATOR')" th:if="${kleUiEnabled == true}" id="kle_performing_menu" th:class="${onlyKleAdmin} ? 'tab-pane fade in active' : 'tab-pane fade'">
								<h4 th:text="#{html.page.ous.edit.search}" />
								<input class="form-control" id="KlePrimarySearch" style="margin-bottom: 5px;"/>
								<button class="btn btn-lg btn-primary" style="margin-bottom: 20px;" th:text="#{html.page.ous.edit.save}" onclick="saveChanges('KlePrimary')"></button>
								<button class="btn btn-lg btn-primary" style="margin-bottom: 20px;" th:text="#{html.page.ous.edit.cancel}" onclick="abortChanges('KlePrimary')"></button>
								<div id="KlePrimary"></div>
							</div>
							<div sec:authorize="hasRole('ROLE_KLE_ADMINISTRATOR')" th:if="${kleUiEnabled == true}" id="kle_insight_menu" class="tab-pane fade">
								<h4 th:text="#{html.page.ous.edit.search}" />
								<input class="form-control" id="KleSecondarySearch" style="margin-bottom: 5px;"/>
								<button class="btn btn-lg btn-primary" style="margin-bottom: 20px;" th:text="#{html.page.ous.edit.save}" onclick="saveChanges('KleSecondary')"></button>
								<button class="btn btn-lg btn-primary" style="margin-bottom: 20px;" th:text="#{html.page.ous.edit.cancel}" onclick="abortChanges('KleSecondary')"></button>
								<div id="KleSecondary"></div>
							</div>

							<div id="users_menu" class="tab-pane fade">
								<div th:replace="ous/fragments/ou_users :: orgUnitUsers(users = ${users})" />
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>
	
	<div class="modal fade bd-example-modal-lg" id="modal-ou" role="dialog">
		<div class="modal-dialog modal-lg">

			<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" onclick="closeModal();">&times;</button>
					<h4 th:text="#{html.page.ous.edit.title.choose}"/>
				</div>

				<div class="modal-body">
					<p th:utext="#{html.page.ous.edit.choose.text.intro}" />
					<ul>
						<li th:if="${titles != null and titles.size() > 0}" th:text="#{html.page.ous.edit.choose.text.titles}"></li>
						<li th:text="#{html.page.ous.edit.choose.text.all}"></li>
						<li th:text="#{html.page.ous.edit.choose.text.remove}"></li>
					</ul>

					<table th:if="${titles != null and titles.size() > 0}" id="listTable" class="table table-striped">
						<thead>
							<tr>
								<th class="col-md-1" th:text="#{html.entity.title.checked}" />
								<th class="col-md-4" th:text="#{html.entity.title.name}" />
							</tr>
						</thead>

						<tbody>
							 <tr th:each="title : ${titles}">
								<td>
									<div class="checkbox c-checkbox">
										<label>
											<input class="title-checkbox" type="checkbox" th:attr="data-id=${title.id}, checked=${title.state.checked}" />
											<span class="fa fa-check"></span>
										</label>
									</div>
								</td>
								<td th:text="${title.name}" />
							</tr>
						</tbody>
					</table>
					
	               	<div style="height: 70px;">
						<h4 class="md-12" th:text="#{html.word.validity}" />
	
						<b class="col-sm-1" style="padding-top: 7px;" th:text="#{html.word.from}"></b>
						<div class="col-md-5">
							<div class="form-group">
								<div class="input-group date" id="startDatePicker">
									<input type="text" class="form-control"/>
									<span class="input-group-addon">
										<span class="fa fa-calendar"></span>
									</span>
								</div>
							</div>
						</div>
	
						<b class="col-sm-1" style="padding-top: 7px;" th:text="#{html.word.to}"></b>
						<div class="col-md-5">
							<div class="form-group">
								<div class="input-group date" id="stopDatePicker">
									<input type="text" class="form-control" />
									<span class="input-group-addon">
										<span class="fa fa-calendar"></span>
									</span>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="modal-footer">
					<button type="button" id="titleAssignTitlesButton" class="btn btn-primary" onclick="handleTitleRoleAssignment()" th:text="#{html.page.ous.edit.button.assign}"/>
					<div class="btn-group" id="titleInheritButton">
                        <button type="button" style="margin-left: 5px;" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                        	<span>
								<span th:text="#{html.page.ous.edit.button.assign.intro}"/>&nbsp;
								<em class="fa fa-fw fa-caret-down"></em>
							</span>
                        </button>
						<ul class="dropdown-menu">
			    			<li><a href="#" onclick="handleEveryoneRoleAssignment(false)" th:text="#{html.page.ous.edit.button.assign.all}" /></li>
	                		<li><a href="#" onclick="handleEveryoneRoleAssignment(true)" th:text="#{html.page.ous.edit.button.assign.all.inheritance}"/></li>
			  			</ul>
			  		</div>
					<button type="button" id="titleNoInheritButton" class="btn btn-primary" style="margin-left: 5px;" onclick="handleEveryoneRoleAssignment(false)" th:text="#{html.page.ous.edit.button.assign.intro}"/>
					<button type="button" class="btn btn-danger" style="margin-left: 5px;" onclick="handleRemoveRoleAssignment()" th:text="#{html.page.ous.edit.button.deassign}"/>
				</div>
			</div>
		</div>
	</div>

	<nav th:replace="fragments/footer :: footer" />
	<script th:replace="fragments/datatables :: datatables(orderColumnValue=1) " />

	<style>
		.table .checkbox {
			margin-left: 10px;
			width: auto;
		}
	</style>
	
	<script th:replace="fragments/assignDatePicker :: content " />

	<script th:inline="javascript">
		/*<![CDATA[*/

		/*[+
		var url = [[@{/rest/ous/}]];
		var urlUi = [[@{/ui/ous/}]];
		var ou = [[${ou.uuid}]];
		var fieldUpdatedMsg = [[#{html.entity.rolegroup.updatedmsg}]];
		var fieldNotUpdatedMsg = [[#{html.entity.rolegroup.failedupdatemsg}]];
		var success = [[#{html.default.message.success}]];
		var failed = [[#{html.default.message.error}]];
		
		// TODO: den her fik vi vist smidt ud med badevandet
		var usersStillAssignedDirectlyMsg = [[#{html.orgunit.role.stillassigned}]];
		var usersAlreadyAssignedDirectlyMsg = [[#{html.orgunit.role.alreadyassigned}]];

		var allInterestKles = [[${allInterestKles}]];
		var allPerformingKles = [[${allPerformingKles}]];
		
		var titles = [[${titles}]];
		var titlesEnabled = [[${titlesEnabled}]];
		+]*/

		var token = $("meta[name='_csrf']").attr("content");
		var klePrimaryInitialized = false;
		var kleSecondaryInitialized = false;
		var checkedTitles = null; 		
		var payload = {
				roleType: '',
				roleId: 0,
				checkboxRef: null
		};

		$(document).ready(function() {

			// polyfill
			if (!String.prototype.format) {
				String.prototype.format = function () {
					var args = [].slice.call(arguments);
		
					return this.replace(/(\{\d+\})/g, function (a) {
						return args[+(a.substr(1,a.length-2))||0];
					});
				};
			}

			// polyfill
			if (!String.prototype.startsWith) {
			    String.prototype.startsWith = function(searchString, position){
			      position = position || 0;
			      return this.substr(position, searchString.length) === searchString;
			  };
			}

			// ensure checkbox listeners are enabled for currently visible checkboxes
			addCheckboxListeners();

			// update checbox listeners on redraw of datatables
			$('#listTable1').on('draw.dt', function () {
				addCheckboxListeners();
			});
			
			$('#listTable2').on('draw.dt', function () {
				addCheckboxListeners();
			});

			// flip active tab on page-load
			var selectedTab = localStorage.getItem(ou);
			if (selectedTab != null) {
				$('a[data-toggle="tab"][href="' + selectedTab + '"]').tab('show');
			}
			
			// setup tab memory
			$('#dataTabs a').click(function (e) {
				e.preventDefault();
				$(this).tab('show');
			});

			$('a[data-toggle="tab"]').on("shown.bs.tab", function (e) {
				var id = $(e.target).attr("href");
				localStorage.setItem(ou, id)

				// just a simple check to see if we have data to show
				if ($('#kle_performing_menu').length > 0) {
					if ("#kle_performing_menu" == id && !klePrimaryInitialized) {
						klePrimaryInitialized = true;
			            initJSTree("KlePrimary", "KlePrimarySearch");
					}
					else if ("#kle_insight_menu" == id && !kleSecondaryInitialized) {
						kleSecondaryInitialized = true;
						initJSTree("KleSecondary", "KleSecondarySearch");					
					}
				}
			});
		});
		
		function addCheckboxListeners() {
			// this adds relevant listeners to all the currently displayed userrole/rolegroup checkboxes
			$('.checkboxaction').off("change");
			$('.checkboxaction').change(handleCheckbox);
			
			// this makes sure the KLE checkbox (inherit KLE) has the relevant event linked to it
			$('.inherit-checkbox').off("change");
			$('.inherit-checkbox').change(inheritCheckboxChange);
			
			// makes sure the title checkboxes on the modal dialogue modifies the underlying datastructure on changes
			$('.title-checkbox').off("change");
			$('.title-checkbox').change(handleTitleCheckbox);
		}

		// this is called when someone checks or unchecks a userrole/rolegroup checkbox
		function handleCheckbox() {
			var inheritAllowed = ("true" == this.dataset.inherit);
			var checked = !this.checked; // checking flips it, and we want the previous value
			var startDate = this.dataset.startDate;
			var stopDate = this.dataset.stopDate;

			payload.roleType = String(this.dataset.objtype);
			payload.roleId = this.id;
			payload.checkboxRef = this;
			
			if (titlesEnabled) {
				// fetch available titles
				$.ajax({
					url: url + ou + "/" + payload.roleType + "/" + payload.roleId + "/titles", 
					method: "POST",
					headers: {
						'X-CSRF-TOKEN': token
					},
	                contentType: 'application/json',
					data: JSON.stringify(titles),
					error : function(response) {
						showErrorNotification(fieldNotUpdatedMsg);
						payload.checkboxRef.checked = !payload.checkboxRef.checked;
					},
					success : function(response) {
						showAssignModal(titlesEnabled, checked, inheritAllowed, response, startDate, stopDate);
					}
				});
			}
			else {
				showAssignModal(titlesEnabled, checked, inheritAllowed, null, startDate, stopDate);
			}
		}
		
		function showAssignModal(titlesEnabled, checked, inheritAllowed, checkedTitles, startDate, stopDate) {
			if (stopDate) {
				$('#startDatePicker').data("DateTimePicker").date(startDate);
				$('#stopDatePicker').data("DateTimePicker").date(stopDate);
			} else {
				$('#stopDatePicker').data("DateTimePicker").clear();
				$('#startDatePicker').data("DateTimePicker").clear();
				$('#startDatePicker').data("DateTimePicker").date(new Date());
			}

			if (titlesEnabled) {
				var anythingChecked = false;

				for (var i = 0; i < titles.length; i++) {
					titles[i].state.checked = (checkedTitles != null && checkedTitles.indexOf(titles[i].id) > -1);
	
					$('.title-checkbox[data-id=' + titles[i].id + ']').prop('checked', titles[i].state.checked);
					
					if (titles[i].state.checked) {
						anythingChecked = true;
					}
				}
				
				$("#titleAssignTitlesButton").show();
				if (!anythingChecked) {
					$("#titleAssignTitlesButton").prop('disabled', true);
				}
				else {
					$("#titleAssignTitlesButton").prop('disabled', false);
				}
			}
			else {
				$("#titleAssignTitlesButton").hide();
			}

			if (inheritAllowed) {
				$("#titleInheritButton").show();
				$("#titleNoInheritButton").hide();
			}
			else {
				$("#titleInheritButton").hide();
				$("#titleNoInheritButton").show();
			}
			
			$("#modal-ou").modal({
				backdrop: 'static',
				keyboard: false
			});
		}

		function assignRole(objType, inherit, id, titleUuids) {
			var endpoint = url + 'add' + objType + '/' + ou + '/' + id;

			var startDate = $('#startDatePicker').data('date');
			var stopDate = $('#stopDatePicker').data('date');
			var dates = "?startDate=" + startDate + "&stopDate=" + stopDate;
			endpoint = endpoint + dates;
			
			if (inherit) {
				endpoint = endpoint + "&inherit=true";
			}
			
			$.ajax({
				url: endpoint,
				method: "POST",
				headers: {
					'X-CSRF-TOKEN': token
				},
                contentType: 'application/json',
                data: JSON.stringify({
    			      'titleUuids': titleUuids
				}),
				error : function(response) {
					showErrorNotification(fieldNotUpdatedMsg);
					closeModalWithState(false);
				},
				success : function(response) {
					if (response.success) {
						if (response.users > 0) {
							var optionalSuccessMessage = usersAlreadyAssignedDirectlyMsg.format(response.users);
							showWarnNotification(optionalSuccessMessage);
						}
						else {
							showInfoNotification(fieldUpdatedMsg);
						}
					}
					else {
						// TODO: should we inform the user that we did not make any change?
						showInfoNotification(fieldUpdatedMsg);
					}
					
					closeModalWithState(true);
				}
			});
			
			// TODO: I doubt this works with failures
			updateCheckboxSorting(objType, id, true);
		}
		
		function deassignRole(objType, id) {
			var endpoint = url + 'remove' + objType + '/' + ou + '/' + id;

			$.ajax({
				url: endpoint,
				method: "POST",
				headers: {
					'X-CSRF-TOKEN': token
				},
				error : function(response) {
					showErrorNotification(fieldNotUpdatedMsg);
					closeModalWithState(true);
				},
				success : function(response) {
					showInfoNotification(fieldUpdatedMsg);
					closeModalWithState(false);
				}
			});
			
			// TODO: I doubt this works with failures
			updateCheckboxSorting(objType, id, false);
		}

		function updateCheckboxSorting(objType, id, checked) {
			// update sorting of checked checkboxes
			if (objType === "role") {
				$("#" + id + "sortLabel").text(checked);
				$("#listTable1").dataTable().api().row("#" + id + "row").invalidate('dom').draw();
			}
			else {
				$("#" + id + "groupSortLabel").text(checked);
				$("#listTable2").dataTable().api().row("#" + id + "groupRow").invalidate('dom').draw();
			}
		}

		// wrapper around assignRole that reads the list of checked title UUIDs called by button click
		function handleTitleRoleAssignment() {
			var titleUuids = [];
			for (var i = 0; i < titles.length; i++) {
				if (titles[i].state.checked) {
					titleUuids.push(titles[i].id);
				}
			}
			
			assignRole(payload.roleType, false, payload.roleId, titleUuids);
		}
		
		// wrapper around assignRole that assigns to everyone called by button click
		function handleEveryoneRoleAssignment(inherit) {
			assignRole(payload.roleType, inherit, payload.roleId, []);			
		}

		// wrapper around deassignRole called by button click
		function handleRemoveRoleAssignment() {
			deassignRole(payload.roleType, payload.roleId);
		}

		// updates button state when a title checkbox is checked/unchecked
		function handleTitleCheckbox() {
			var anythingChecked = false;

			for (var i = 0; i < titles.length; i++) {				
				if (titles[i].id == $(this).data('id')) {
					titles[i].state.checked = this.checked;					
				}
				
				if (titles[i].state.checked) {
					anythingChecked = true;
				}
			}
			
			if (!anythingChecked) {
				$("#titleAssignTitlesButton").prop('disabled', true);
			}
			else {
				$("#titleAssignTitlesButton").prop('disabled', false);
			}
		}
		
		function closeModalWithState(checkboxState) {
			payload.checkboxRef.checked = checkboxState;

			$('#modal-ou').modal('toggle');
		}
		
		function closeModal() {
			payload.checkboxRef.checked = !payload.checkboxRef.checked;

			$('#modal-ou').modal('toggle');
		}

		function showInfoNotification(message) {
			$.notify({
				message: message,
				status: 'success',
				timeout: 2000
			});
		}
		
		function showWarnNotification(message) {
			$.notify({
				message: message,
				status: 'warning',
				timeout: 3000
			});
		}

		function showErrorNotification(message) {
			$.notify({
				message: message,
				status: 'danger',
				timeout: 4000
			});
		}

		//// BEGIN KLE CODE ////
		function initJSTree(id, search, selected) {
			$('#' + id).jstree({
					"core": {
						"data": (id == 'KlePrimary') ? allPerformingKles : allInterestKles,
						"themes": {
							"icons": false
						}
					},
					"checkbox" : {
						"keep_selected_style" : false,
						"three_state": false,
						"tie_selection": false, // this allow us to send checked state in input data
						"cascade": "undetermined"
					},
					"search" : {
						"show_only_matches": true,
						"search_callback": function(str, node) {
							// special KLE search support
							var kleValue = str.split('.').join("");
							if (!isNaN(kleValue)) {
								if (kleValue.length > 4) {
									kleValue = kleValue.substr(0, 2) + "." + kleValue.substr(2, 2) + "." + kleValue.substr(4);
								}
								else if (kleValue.length > 2) {
									kleValue = kleValue.substr(0, 2) + "." + kleValue.substr(2);
								}
								
								return (node.text.startsWith(kleValue));
							}

							return (node.text.toUpperCase().includes(str.toUpperCase()));
						}
					},
					"plugins" : [
						"wholerow", "search", "checkbox"
					]
			}).on("check_node.jstree uncheck_node.jstree", function(e, data) {
				var id = data.node.id;
				var checked = data.node.state.checked;

				var set = (data.event.delegateTarget.id == "KlePrimary") ? allPerformingKles : allInterestKles;

				for (var i = 0; i < set.length; i++) {
					if (set[i].id == id) {
						set[i].state.checked = checked;
					}
				}
			});

			// Searching in the JSTree
			var to = false;
			$('#' + search).keyup(function() {
				if (to) {
					clearTimeout(to);
				}

				to = setTimeout(function() {
					var v = $('#' + search).val();

					$('#' + id).jstree(true).search(v);
				}, 400);
			});
		};

		function saveChanges(id) {
			var tmpCodes = [];
			var set = (id == "KlePrimary") ? allPerformingKles : allInterestKles;
			for (var i = 0; i < set.length; i++) {
				if (set[i].state.checked) {
					tmpCodes.push(set[i].id);
				}
			}
			
			// sort in order of length (descending)
			tmpCodes.sort(function(a,b) {
				return b.length - a.length;
			});
			
			// remove sub-selections (works because of order)
			var codes = [];
			for (var i = 0; i < tmpCodes.length; i++) {
				var code = tmpCodes[i];
				
				// small optimization
				if (tmpCodes[i].length < 6) {
					for (var j = codes.length - 1; j >= 0; j--) {
						if (codes[j].startsWith(code)) {
							codes.splice(j, 1);
						}
					}
				}
				
				codes.push(code);
			}

			$.ajax({
				contentType: 'application/json',
				url: url + "updateAll/kle",
				method : "POST",
				headers: {
					"uuid": ou,
					"type": id,
					'X-CSRF-TOKEN': token
				},
				error: function(response) {
					$.notify({
						message: fieldNotUpdatedMsg
					}, {
						status: 'danger',
						autoHideDelay: 4000
					});
				},
				success: function(response) {
					$.notify({
						message: fieldUpdatedMsg
					}, {
						status: 'success',
						autoHideDelay: 2000
					});
				},
				data: JSON.stringify(codes)
			});
		}

		function abortChanges(id) {
			location.reload();
		}

		// handler for setting OU level
		function setLevel(el) {
			var updateUrl = url + ou + "/setLevel/" + $(el).val();
			
			$.ajax({
				url: updateUrl,
				method: "POST",
				headers: {
					'X-CSRF-TOKEN': token
				},
				error: function(response) {
					$.notify({
						message: response.responseText
					}, {
						status: 'danger',
						autoHideDelay: 4000
					});
				},
				success: function(response) {	
					$.notify({
						message: fieldUpdatedMsg
					}, {
						status: 'success',
						autoHideDelay: 2000
					});
				}
			});
		}

		// handler for setting KLE inherit
		function inheritCheckboxChange() {
			var updateUrl = url + ou + "/inherit";

			if (this.checked) {
				updateUrl = updateUrl + "?active=true";
			}
			else {
				updateUrl = updateUrl + "?active=false";
			}
			
			$.ajax({
				url: updateUrl,
				method: "POST",
				headers: {
					'X-CSRF-TOKEN': token
				},
				error: function(response) {
					$.notify({
						message: response.responseText
					}, {
						status: 'danger',
						autoHideDelay: 4000
					});
				},
				success: function(response) {	
					$.notify({
						message: fieldUpdatedMsg
					}, {
						status: 'success',
						autoHideDelay: 2000
					});
				}
			});
		}
		
		/*]]>*/
	</script>
</body>
</html>
