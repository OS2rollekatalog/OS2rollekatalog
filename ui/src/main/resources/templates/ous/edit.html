<!DOCTYPE html>
<html>
<head th:replace="fragments/header :: header (title=#{html.page.ous.edit.title})" />
<body>
	<div class="wrapper">
		<header th:replace="fragments/navbar :: navbar-header(subpage = 'roles')" />
		<aside th:replace="fragments/navbar :: navbar-aside (page = 'ous', subpage = 'roles')" />
		
		<section>
			<div class="content-wrapper">
				<h3>
					<a th:href="@{/ui/ous/list}" class="btn btn-default">
						<span>
							<i class="fa fa-arrow-left"></i>
						</span>
					</a>
					<span th:text="#{html.page.ous.edit.title}"></span>
				</h3>

				<div class="panel panel-default">
					<div class="panel-heading"></div>
					<div class="panel-body">
						<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
							<div class="panel panel-default">
								<div class="panel-heading" role="tab" id="stamdataHeading">
									<h4 class="panel-title">
										<a role="button" id="stamdataLink" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
											<em id="caretIcon" class="fa fa-caret-right"></em>&nbsp;
											<span th:text="#{html.heading.stamdata}"></span>
											<span th:text="${ou.name}"></span>
										</a>
									</h4>
								</div>

								<div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="stamdataHeading">
									<div class="panel-body">
										<form class="form-horizontal" th:object="${ou}">
											<fieldset>
												<div class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.entity.ou.name}" />
													<div class="col-sm-8">
														<input th:field="${ou.name}" class="form-control" disabled="disabled" />
													</div>
												</div>
											</fieldset>

											<fieldset sec:authorize="hasRole('ROLE_ADMINISTRATOR')">
												<div th:if="${@roleCatalogueConfiguration.getOrganisation().isGetLevelsFromApi() == false}" class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.entity.ou.level}" />
													<div class="col-sm-8">
														<select onchange="setLevel(this);" class="form-control">
															<option th:each="level : ${allowedLevels}"
																th:value="${level}" th:text="#{__${level.message}__}"
																th:selected="${level} == *{level}"></option>
														</select>
													</div>
												</div>
												
												<div th:if="${@roleCatalogueConfiguration.getOrganisation().isGetLevelsFromApi() == true}" class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.entity.ou.level}" />
													<div class="col-sm-8">
														<input th:value="#{__${ou.level.message}__}" class="form-control" disabled="disabled" />
													</div>
												</div>
											</fieldset>
														
											<fieldset sec:authorize="!hasRole('ROLE_ADMINISTRATOR')">
												<div class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.entity.ou.level}" />
													<div class="col-sm-8">
														<input th:value="#{__${ou.level.message}__}" class="form-control" disabled="disabled" />
													</div>
												</div>
											</fieldset>

											<fieldset>
												<div class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.entity.ou.manager}" />
													<div class="col-sm-8">
														<input th:value="${ou.manager} != null ? ${ou.manager.name} : ''" class="form-control" disabled="disabled" />
													</div>
												</div>
											</fieldset>
											
											<fieldset sec:authorize="hasRole('ROLE_ADMINISTRATOR')" th:if="${@settingsService.isRequestApproveEnabled() == true && @settingsService.getRequestApproveWho() == T(dk.digitalidentity.rc.service.model.WhoCanRequest).AUTHORIZATION_MANAGER}">
												<div class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.page.ous.edit.authorizationManager}"/>
													<div class="col-sm-8">
														<input style="width: 600px; display: inline-block;" class="form-control" id="search_person" onclick="return false;" th:title="#{html.page.ous.edit.authorizationManager.title}" />

														<table class="table table-striped" style="width: 600px;">
															<thead>
																<tr>
																	<th class="col-md-6" th:text="#{html.entity.user.name}" />
																	<th class="col-md-5" th:text="#{html.entity.user.userId}" />
																	<th class="col-md-1" th:text="#{html.control.operations}" />
																</tr>
															</thead>
															
															<tbody>
																<tr th:each="authManager : ${ou.authorizationManagers}">
																	<td th:text="${authManager.user.name}" />
																	<td th:text="${authManager.user.userId}" />
																	<td>
																		<a onclick="autoCompleteService.removeAuthManager(this); return false;" th:data-uuid="${authManager.user.uuid}"><em class="fa fa-fw fa-times"></em></a>
																	</td>
																</tr>
															</tbody>
														</table>
													</div>
												</div>
											</fieldset>
											
											<fieldset th:if="${kleUiEnabled == true}" sec:authorize="hasRole('ROLE_KLE_ADMINISTRATOR')">
												<div class="form-group">
													<label class="col-sm-2 control-label" th:text="#{html.orgunit.settings}"></label>
													<div class="col-sm-8">
														<div class="checkbox c-checkbox">
															<label>
																<input class="inherit-checkbox" type="checkbox" data-flag="inherit" th:attr="checked=${ou.inheritKle}"/>
																<span class="fa fa-check"></span>
															</label>
															
															<label th:text="#{html.orgunit.flag.inherit}"></label>
														</div>
													</div>
												</div>
												
												<div class="form-group" th:if="${#lists.size(parentsKleIsInheritedFrom)} > 0">
													<div class="col-sm-offset-2 col-sm-8" style="margin-top: 20px;">
														<span style="font-weight: bold;" th:text="#{html.orgunit.kle.inherited.from}" />
														<ul>
															<li th:each="ouInheritedFrom : ${parentsKleIsInheritedFrom}" th:text="${ouInheritedFrom.name}" />
														</ul>
													</div>
												</div>
											</fieldset>
										</form>
									</div>
								</div>
							</div>
						</div>

						<ul class="nav nav-tabs" id="dataTabs">
							<li th:class="${!onlyKleAdmin} ? active : ''" sec:authorize="hasRole('ROLE_ASSIGNER')">
								<a data-toggle="tab" href="#roles_menu" th:text="#{html.page.ous.list.roles}"></a>
							</li>

							<li sec:authorize="hasRole('ROLE_ASSIGNER')">
								<a data-toggle="tab" href="#groups_menu" th:text="#{html.page.ous.list.rolegroups}"></a>
							</li>

							<li th:class="${onlyKleAdmin} ? active : ''" th:if="${kleUiEnabled == true}" sec:authorize="hasRole('ROLE_KLE_ADMINISTRATOR')">
								<a data-toggle="tab" id="kleFirstTab" href="#kle_performing_menu" th:text="#{html.page.ous.list.kleperform}"></a>
							</li>
							
							<li th:if="${kleUiEnabled == true}" sec:authorize="hasRole('ROLE_KLE_ADMINISTRATOR')">
								<a data-toggle="tab" href="#kle_insight_menu" th:text="#{html.page.ous.list.kleinterest}"></a>
							</li>

							<li>
								<a data-toggle="tab" href="#users_menu" th:text="#{html.page.ous.list.users}"></a>
							</li>
						</ul>

						<div class="tab-content">
							<div id="roles_menu" th:class="${!onlyKleAdmin} ? 'tab-pane fade in active' : 'tab-pane fade'">
								<table id="listTable1" class="table table-striped table-hover listTable">
									<thead>
										<tr>
											<th class="col-md-1" th:text="#{html.entity.rolegroup.enabled}" />
											<th class="col-md-2" th:text="#{html.entity.rolegroup.name}" />
											<th class="col-md-2" th:text="#{html.entity.rolegroup.itsystem}" />
											<th class="col-md-2" th:text="#{html.entity.rolegroup.validity}"/>
											<th class="col-md-1" th:text="#{html.entity.title.count}" />
											<th class="col-md-4" th:text="#{html.entity.rolegroup.description}" />
										</tr>
									</thead>

									<tbody>
										<tr th:each="addRole : ${addRoles}" th:id="${addRole.role.id}+'roleRow'" th:attr="data-ou=${addRole.ouAssignment}">
											<td>
												<div class="checkbox c-checkbox">
													<label>
														<input th:id="${addRole.role.id}" type="checkbox" th:checked="${addRole.checked}" class="checkboxaction" th:disabled="${addRole.role.itSystem.readonly}"
																th:attr="data-startdate=${addRole.assignment.startDate}, data-stopdate=${addRole.assignment.stopDate}" data-objtype="role"/>
														<span class="fa fa-check"></span>
													</label>
												</div>
												<label th:id="${addRole.role.id}+'sortLabel'" style="display:none" th:text="${addRole.checked}"/>
											</td>
											<td th:text="${addRole.role.name}" />
											<td th:text="${addRole.role.itSystem.name}" />

		                                    <td class="fromToDate">
		                                    	<ul th:if="${addRole.assignment.startDate != null or addRole.assignment.stopDate != null}" style="padding-left: 0px; list-style-type: none;">
			                                    	<li th:if="${addRole.assignment.startDate != null}" th:text="#{html.word.assigned} + ' ' + ${addRole.assignment.startDate}"></li>
			                                    	<li th:if="${addRole.assignment.stopDate != null}" th:text="#{html.word.deassigned} + ' ' + ${addRole.assignment.stopDate}"></li>
		                                    	</ul>
		                                    	<span th:if="${addRole.checked == true and addRole.assignment.startDate == null and addRole.assignment.stopDate == null}" th:text="#{html.word.indefinite}"/>
		                                    </td>
											
											<th:block th:switch="${addRole.assignmentType}">
												<td th:case="-2" th:text="#{html.entity.ou.assigned.inherit}" />
												<td th:case="-1">
													<p th:unless="${addRole.containsExceptedUsers}" th:text="#{html.entity.ou.assigned.all}"></p>
													<p th:if="${addRole.containsExceptedUsers}" th:text="#{html.entity.ou.assigned.all.with.exceptions}"></p>
												</td>
												<td th:case="0"></td>
												<td th:case="1" th:text="#{html.entity.ou.assigned.one}" />
												<td th:case="*" th:text="#{html.entity.ou.assigned.many(${addRole.assignmentType})}" />
											</th:block>

											<td th:text="${addRole.role.description}" />
										</tr>
									</tbody>
								</table>
							</div>

							<div id="groups_menu" class="tab-pane fade">
								<table id="listTable2" class="table table-striped table-hover listTable">
									<thead>
										<tr>
											<th class="col-md-1" th:text="#{html.entity.rolegroup.enabled}" />
											<th class="col-md-2" th:text="#{html.entity.rolegroup.name}" />
											<th class="col-md-2" th:text="#{html.entity.rolegroup.validity}"/>
											<th class="col-md-1" th:text="#{html.entity.title.count}" />
											<th class="col-md-6" th:text="#{html.entity.rolegroup.description}" />
										</tr>
									</thead>

									<tbody>
										<tr th:each="addRolegroup : ${addRoleGroups}" th:id="${addRolegroup.roleGroup.id}+'roleGroupRow'" th:attr="data-inherit=${addRolegroup.checkedWithInherit}">
											<td>
												<div class="checkbox c-checkbox">
													<label>
														<input th:id="${addRolegroup.roleGroup.id}" type="checkbox" th:checked="${addRolegroup.checked}" class="checkboxaction" 
																th:attr="data-startdate=${addRolegroup.assignment.startDate},data-stopdate=${addRolegroup.assignment.stopDate}" data-objtype="rolegroup" />
														<span class="fa fa-check"></span>
													</label>
												</div>
												<label th:id="${addRolegroup.roleGroup.id}+'groupSortLabel'" style="display:none" th:text="${addRolegroup.checked}"/>
											</td>
											<td th:text="${addRolegroup.roleGroup.name}" />

		                                    <td class="fromToDate">
		                                    	<ul th:if="${addRolegroup.assignment.startDate != null or addRolegroup.assignment.stopDate != null}" style="padding-left: 0px; list-style-type: none;">
			                                    	<li th:if="${addRolegroup.assignment.startDate != null}" th:text="#{html.word.assigned} + ' ' + ${addRolegroup.assignment.startDate}"></li>
			                                    	<li th:if="${addRolegroup.assignment.stopDate != null}" th:text="#{html.word.deassigned} + ' ' + ${addRolegroup.assignment.stopDate}"></li>
		                                    	</ul>
		                                    	<span th:if="${addRolegroup.checked == true and addRolegroup.assignment.startDate == null and addRolegroup.assignment.stopDate == null}" th:text="#{html.word.indefinite}"/>
		                                    </td>

											<th:block th:switch="${addRolegroup.assignmentType}">
												<td th:case="-2" th:text="#{html.entity.ou.assigned.inherit}" />
												<td th:case="-1">
													<p th:unless="${addRolegroup.containsExceptedUsers}" th:text="#{html.entity.ou.assigned.all}"></p>
													<p th:if="${addRolegroup.containsExceptedUsers}" th:text="#{html.entity.ou.assigned.all.with.exceptions}"></p>
												</td>
												<td th:case="0"></td>
												<td th:case="1" th:text="#{html.entity.ou.assigned.one}" />
												<td th:case="*" th:text="#{html.entity.ou.assigned.many(${addRolegroup.assignmentType})}" />
											</th:block>

											<td th:text="${addRolegroup.roleGroup.description}" />
										</tr>
									</tbody>
								</table>
							</div>

							<div sec:authorize="hasRole('ROLE_KLE_ADMINISTRATOR')" th:if="${kleUiEnabled == true}" id="kle_performing_menu" th:class="${onlyKleAdmin} ? 'tab-pane fade in active' : 'tab-pane fade'">
								<h4 th:text="#{html.page.ous.edit.search}" />
								<input class="form-control" id="KlePrimarySearch" style="margin-bottom: 5px;"/>
								<button class="btn btn-lg btn-primary" style="margin-bottom: 20px;" th:text="#{html.page.ous.edit.save}" onclick="saveChanges('KlePrimary')"></button>
								<button class="btn btn-lg btn-primary" style="margin-bottom: 20px;" th:text="#{html.page.ous.edit.cancel}" onclick="abortChanges('KlePrimary')"></button>
								<div id="KlePrimary"></div>
							</div>
							<div sec:authorize="hasRole('ROLE_KLE_ADMINISTRATOR')" th:if="${kleUiEnabled == true}" id="kle_insight_menu" class="tab-pane fade">
								<h4 th:text="#{html.page.ous.edit.search}" />
								<input class="form-control" id="KleSecondarySearch" style="margin-bottom: 5px;"/>
								<button class="btn btn-lg btn-primary" style="margin-bottom: 20px;" th:text="#{html.page.ous.edit.save}" onclick="saveChanges('KleSecondary')"></button>
								<button class="btn btn-lg btn-primary" style="margin-bottom: 20px;" th:text="#{html.page.ous.edit.cancel}" onclick="abortChanges('KleSecondary')"></button>
								<div id="KleSecondary"></div>
							</div>

							<div id="users_menu" class="tab-pane fade">
								<div th:replace="ous/fragments/ou_users :: orgUnitUsers(users = ${users})" />
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>
	
	<div th:replace="ous/fragments/ou_roles_modal :: ouRolesModal(titles = ${titles})" />

	<nav th:replace="fragments/footer :: footer" />
	<script th:replace="fragments/datatables :: datatables(orderColumnValue=1) " />

	<style>
		.table .checkbox {
			margin-left: 10px;
			width: auto;
		}
		
		.autocomplete-suggestions { border: 1px solid #999; background: #FFF; overflow: auto; width: 500px !important; }
		.autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
		.autocomplete-selected { background: #F0F0F0; }
		.autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
		.autocomplete-group { padding: 2px 5px; }
		.autocomplete-group strong { display: block; border-bottom: 1px solid #000; }
	</style>
	
	<script th:replace="fragments/assignDatePicker :: content " />
	<script th:replace="ous/fragments/ou_roles_modal :: ouRoleGroupModalScript(titlesEnabled=${titlesEnabled})" />

	<script th:inline="javascript">
		/*<![CDATA[*/

		/*[+
		var url = [[@{/rest/ous/}]];
		var urlUi = [[@{/ui/ous/}]];
		var ou = [[${ou.uuid}]];
		var fieldUpdatedMsg = [[#{html.entity.rolegroup.updatedmsg}]];
		var fieldNotUpdatedMsg = [[#{html.entity.rolegroup.failedupdatemsg}]];
		var success = [[#{html.default.message.success}]];
		var failed = [[#{html.default.message.error}]];
		
		// TODO: den her fik vi vist smidt ud med badevandet
		var usersStillAssignedDirectlyMsg = [[#{html.orgunit.role.stillassigned}]];
		var usersAlreadyAssignedDirectlyMsg = [[#{html.orgunit.role.alreadyassigned}]];

		var allInterestKles = [[${allInterestKles}]];
		var allPerformingKles = [[${allPerformingKles}]];
		
		var titles = [[${titles}]];
		var titlesEnabled = [[${titlesEnabled}]];
		
		var restUrl = [[@{/rest/ous/}]];
		var substituteUrl = [[@{/rest/manager/substitute}]];
		var msgAssignSuccess = [[#{html.page.manager.substitute.assign.success}]];
		var msgAssignFailure = [[#{html.page.manager.substitute.assign.failure}]];
		+]*/

		var token = $("meta[name='_csrf']").attr("content");
		var klePrimaryInitialized = false;
		var kleSecondaryInitialized = false;
		var autoCompleteService;

		$(document).ready(function() {
			autoCompleteService = new AutoCompleteService();
			autoCompleteService.init();

			// polyfill
			if (!String.prototype.format) {
				String.prototype.format = function () {
					var args = [].slice.call(arguments);
		
					return this.replace(/(\{\d+\})/g, function (a) {
						return args[+(a.substr(1,a.length-2))||0];
					});
				};
			}

			// polyfill
			if (!String.prototype.startsWith) {
			    String.prototype.startsWith = function(searchString, position){
			      position = position || 0;
			      return this.substr(position, searchString.length) === searchString;
			  };
			}

			// ensure checkbox listeners are enabled for currently visible checkboxes
			addCheckboxListeners();

			// update checbox listeners on redraw of datatables
			$('#listTable1').on('draw.dt', function () {
				addCheckboxListeners();
			});
			
			$('#listTable2').on('draw.dt', function () {
				addCheckboxListeners();
			});

			// flip active tab on page-load
			var selectedTab = localStorage.getItem(ou);
			if (selectedTab != null) {
				$('a[data-toggle="tab"][href="' + selectedTab + '"]').tab('show');
			}
			
			// setup tab memory
			$('#dataTabs a').click(function (e) {
				e.preventDefault();
				$(this).tab('show');
			});

			$('a[data-toggle="tab"]').on("shown.bs.tab", function (e) {
				var id = $(e.target).attr("href");
				localStorage.setItem(ou, id)

				// just a simple check to see if we have data to show
				if ($('#kle_performing_menu').length > 0) {
					if ("#kle_performing_menu" == id && !klePrimaryInitialized) {
						klePrimaryInitialized = true;
			            initJSTree("KlePrimary", "KlePrimarySearch");
					}
					else if ("#kle_insight_menu" == id && !kleSecondaryInitialized) {
						kleSecondaryInitialized = true;
						initJSTree("KleSecondary", "KleSecondarySearch");					
					}
				}
			});
			
			//for loading titles in the javascript fragment
			payload.ouUuid=ou;
			ouRolesModalService.loadTitles(false);
			
			if (location.href.indexOf('?reload') > 0) {
				$('#collapseOne').collapse();
			}
		});
		
		function addCheckboxListeners() {
			// this adds relevant listeners to all the currently displayed userrole/rolegroup checkboxes
			$('.checkboxaction').off("change");
			$('.checkboxaction').change(handleCheckbox);
			
			// this makes sure the KLE checkbox (inherit KLE) has the relevant event linked to it
			$('.inherit-checkbox').off("change");
			$('.inherit-checkbox').change(inheritCheckboxChange);
		}

		// this is called when someone checks or unchecks a userrole/rolegroup checkbox
		function handleCheckbox() {
			var checked = !this.checked; // checking flips it, and we want the previous value
			var startDate = this.dataset.startdate;
			var stopDate = this.dataset.stopdate;

			payload.roleType = String(this.dataset.objtype);
			payload.roleId = this.id;
			payload.checkboxRef = this;
			
			if (titlesEnabled) {
				// fetch available titles
				$.ajax({
					url: url + ou + "/" + payload.roleType + "/" + payload.roleId + "/titles", 
					method: "POST",
					headers: {
						'X-CSRF-TOKEN': token
					},
	                contentType: 'application/json',
					data: JSON.stringify(titles),
					error : function(response) {
						showErrorNotification(fieldNotUpdatedMsg);
						payload.checkboxRef.checked = !payload.checkboxRef.checked;
					},
					success : function(response) {
						ouRolesModalService.showAssignModal(titlesEnabled, checked, response, startDate, stopDate);
					}
				});
			}
			else {
				ouRolesModalService.showAssignModal(titlesEnabled, checked, null, startDate, stopDate);
			}
		}
		

		function updateCheckboxSorting(objType, id, checked) {
			// update sorting of checked checkboxes
			if (objType === "role") {
				$("#" + id + "sortLabel").text(checked);
				$("#listTable1").dataTable().api().row("#" + id + "row").invalidate('dom').draw();
			}
			else {
				$("#" + id + "groupSortLabel").text(checked);
				$("#listTable2").dataTable().api().row("#" + id + "groupRow").invalidate('dom').draw();
			}
		}

		function showInfoNotification(message) {
			$.notify({
				message: message,
				status: 'success',
				timeout: 2000
			});
		}
		
		function showWarnNotification(message) {
			$.notify({
				message: message,
				status: 'warning',
				timeout: 3000
			});
		}

		function showErrorNotification(message) {
			$.notify({
				message: message,
				status: 'danger',
				timeout: 4000
			});
		}

		//// BEGIN KLE CODE ////
		function initJSTree(id, search, selected) {
			$('#' + id).jstree({
					"core": {
						"data": (id == 'KlePrimary') ? allPerformingKles : allInterestKles,
						"themes": {
							"icons": false
						}
					},
					"checkbox" : {
						"keep_selected_style" : false,
						"three_state": false,
						"tie_selection": false, // this allow us to send checked state in input data
						"cascade": "undetermined"
					},
					"search" : {
						"show_only_matches": true,
						"search_callback": function(str, node) {
							// special KLE search support
							var kleValue = str.split('.').join("");
							if (!isNaN(kleValue)) {
								if (kleValue.length > 4) {
									kleValue = kleValue.substr(0, 2) + "." + kleValue.substr(2, 2) + "." + kleValue.substr(4);
								}
								else if (kleValue.length > 2) {
									kleValue = kleValue.substr(0, 2) + "." + kleValue.substr(2);
								}
								
								return (node.text.startsWith(kleValue));
							}

							return (node.text.toUpperCase().includes(str.toUpperCase()));
						}
					},
					"plugins" : [
						"wholerow", "search", "checkbox"
					]
			}).on("check_node.jstree uncheck_node.jstree", function(e, data) {
				var id = data.node.id;
				var checked = data.node.state.checked;

				var set = (data.event.delegateTarget.id == "KlePrimary") ? allPerformingKles : allInterestKles;

				for (var i = 0; i < set.length; i++) {
					if (set[i].id == id) {
						set[i].state.checked = checked;
					}
				}
			});

			// Searching in the JSTree
			var to = false;
			$('#' + search).keyup(function() {
				if (to) {
					clearTimeout(to);
				}

				to = setTimeout(function() {
					var v = $('#' + search).val();

					$('#' + id).jstree(true).search(v);
				}, 400);
			});
		};

		function saveChanges(id) {
			var tmpCodes = [];
			var set = (id == "KlePrimary") ? allPerformingKles : allInterestKles;
			for (var i = 0; i < set.length; i++) {
				if (set[i].state.checked) {
					tmpCodes.push(set[i].id);
				}
			}
			
			// sort in order of length (descending)
			tmpCodes.sort(function(a,b) {
				return b.length - a.length;
			});
			
			// remove sub-selections (works because of order)
			var codes = [];
			for (var i = 0; i < tmpCodes.length; i++) {
				var code = tmpCodes[i];
				
				// small optimization
				if (tmpCodes[i].length < 6) {
					for (var j = codes.length - 1; j >= 0; j--) {
						if (codes[j].startsWith(code)) {
							codes.splice(j, 1);
						}
					}
				}
				
				codes.push(code);
			}

			$.ajax({
				contentType: 'application/json',
				url: url + "updateAll/kle",
				method : "POST",
				headers: {
					"uuid": ou,
					"type": id,
					'X-CSRF-TOKEN': token
				},
				error: function(response) {
					$.notify({
						message: fieldNotUpdatedMsg
					}, {
						status: 'danger',
						autoHideDelay: 4000
					});
				},
				success: function(response) {
					$.notify({
						message: fieldUpdatedMsg
					}, {
						status: 'success',
						autoHideDelay: 2000
					});
				},
				data: JSON.stringify(codes)
			});
		}

		function abortChanges(id) {
			location.reload();
		}

		// handler for setting OU level
		function setLevel(el) {
			var updateUrl = url + ou + "/setLevel/" + $(el).val();
			
			$.ajax({
				url: updateUrl,
				method: "POST",
				headers: {
					'X-CSRF-TOKEN': token
				},
				error: function(response) {
					$.notify({
						message: response.responseText
					}, {
						status: 'danger',
						autoHideDelay: 4000
					});
				},
				success: function(response) {	
					$.notify({
						message: fieldUpdatedMsg
					}, {
						status: 'success',
						autoHideDelay: 2000
					});
				}
			});
		}

		// handler for setting KLE inherit
		function inheritCheckboxChange() {
			var updateUrl = url + ou + "/inherit";

			if (this.checked) {
				updateUrl = updateUrl + "?active=true";
			}
			else {
				updateUrl = updateUrl + "?active=false";
			}
			
			$.ajax({
				url: updateUrl,
				method: "POST",
				headers: {
					'X-CSRF-TOKEN': token
				},
				error: function(response) {
					$.notify({
						message: response.responseText
					}, {
						status: 'danger',
						autoHideDelay: 4000
					});
				},
				success: function(response) {	
					$.notify({
						message: fieldUpdatedMsg
					}, {
						status: 'success',
						autoHideDelay: 2000
					});
				}
			});
		}
		
		function AutoCompleteService() {
			this.init = function() {
				var searchField = $("#search_person");

				searchField.autocomplete({
					serviceUrl: substituteUrl + "/search/person",
					onSelect: function(suggestion) {
						$(this).val(suggestion.value);

						searchField.val("");
						autoCompleteService.addAuthManager(suggestion.data);
					},
					preventBadQueries: true,
					triggerSelectOnValidInput: false
				});
			};

			this.removeAuthManager = function(elem) {
				var personUuid = $(elem).data('uuid');
				
				$.ajax({
					method : "POST",
					url: restUrl + ou + "/authorizationmanager/remove",
					headers: {
						"content-type": "plain/text",
						'X-CSRF-TOKEN': token
					},
					data: personUuid
				}).done(function (data) {
					if (location.href.indexOf('?reload') < 0) {
						location.href = location.href + "?reload";
					}
					else {
						location.reload(true);
					}
				}).fail(function (jqXHR, textStatus, errorThrown) {
					$.notify({
						message: msgAssignFailure
					}, {
						status: 'danger',
						autoHideDelay: 4000
					});
				});
			};
			
			this.addAuthManager = function(personUuid) {
				$.ajax({
					method : "POST",
					url: restUrl + ou + "/authorizationmanager/save",
					headers: {
						"content-type": "plain/text",
						'X-CSRF-TOKEN': token
					},
					data: personUuid
				}).done(function (data) {
					if (window.location.href.indexOf('?reload') < 0) {
						location.href = location.href + "?reload";
					}
					else {
						location.reload(true);
					}
				}).fail(function (jqXHR, textStatus, errorThrown) {
					$.notify({
						message: msgAssignFailure
					}, {
						status: 'danger',
						autoHideDelay: 4000
					});
				});
			};
		}
		
		/*]]>*/
	</script>
</body>
</html>
