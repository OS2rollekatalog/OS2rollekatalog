<th:block th:fragment="ouRolesModal" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
	<div class="modal fade bd-example-modal-lg" id="modal-ou" role="dialog">
		<div class="modal-dialog modal-lg">

			<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" onclick="ouRolesModalService.closeModal();">&times;</button>
					<h4 th:text="#{html.page.ous.edit.title.choose}"/>
				</div>

				<div class="modal-body" style="overflow-y: initial !important;">
					<p th:utext="#{html.page.ous.edit.choose.text.intro}" />
					<ul>
						<li th:if="${titles != null and titles.size() > 0}" th:text="#{html.page.ous.edit.choose.text.titles}"></li>
						<li th:text="#{html.page.ous.edit.choose.text.exceptedusers}"></li>
						<li th:text="#{html.page.ous.edit.choose.text.all}"></li>
						<li th:text="#{html.page.ous.edit.choose.text.remove}"></li>
					</ul>

					<ul class="nav nav-tabs" id="dataTabs">
						<li sec:authorize="hasRole('ROLE_ASSIGNER')" th:if="${titles != null and titles.size() > 0}">
							<a data-toggle="tab" data-tab-type="ou_roles_title_menu" href="#ou_roles_title_menu" th:text="#{html.page.ous.edit.tab.titles}"></a>
						</li>

						<li sec:authorize="hasRole('ROLE_ASSIGNER')">
							<a data-toggle="tab" data-tab-type="ou_roles_excepted_users_menu" href="#ou_roles_excepted_users_menu" th:text="#{html.page.ous.edit.tab.exceptedusers}"></a>
						</li>
					</ul>

					<div class="tab-content">
						<div id="ou_roles_title_menu" class="tab-pane fade in active" th:if="${titles != null and titles.size() > 0}">
							<table th:if="${titles != null and titles.size() > 0}" id="ou_roles_listTable1" class="table table-striped">
								<thead>
									<tr>
										<th class="col-md-2" th:text="#{html.entity.title.checked}" />
										<th class="col-md-10" th:text="#{html.entity.title.name}" />
									</tr>
								</thead>

								<tbody>
									 <tr th:each="title : ${titles}">
										<td>
											<div class="checkbox c-checkbox">
												<label>
													<input class="title-checkbox" type="checkbox" th:attr="data-id=${title.id}, checked=${title.state.checked}" />
													<span class="fa fa-check"></span>
												</label>
											</div>
										</td>
										<td th:text="${title.name}" />
									</tr>
								</tbody>
							</table>
						</div>

						<div id="ou_roles_excepted_users_menu" class="tab-pane fade in" th:classappend ="${titles != null and titles.size() > 0} ? '' : 'in active'">
							<div th:replace="ous/fragments/ou_excepted_users :: table"></div>
						</div>
					</div>
					
	               	<div style="height: 70px;">
						<h4 class="md-12" th:text="#{html.word.validity}" />
	
						<b class="col-sm-1" style="padding-top: 7px;" th:text="#{html.word.from}"></b>
						<div class="col-md-5">
							<div class="form-group">
								<div class="input-group date" id="startDatePickerOU">
									<input type="text" class="form-control"/>
									<span class="input-group-addon">
										<span class="fa fa-calendar"></span>
									</span>
								</div>
							</div>
						</div>
	
						<b class="col-sm-1" style="padding-top: 7px;" th:text="#{html.word.to}"></b>
						<div class="col-md-5">
							<div class="form-group">
								<div class="input-group date" id="stopDatePickerOU">
									<input type="text" class="form-control" />
									<span class="input-group-addon">
										<span class="fa fa-calendar"></span>
									</span>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="modal-footer">
					<button type="button" disabled="disabled" id="titleAssignTitlesButton" class="btn btn-primary" onclick="ouRolesModalService.handleTitleRoleAssignment()" th:text="#{html.page.ous.edit.button.assign}"/>
					<button type="button" disabled="disabled" id="assignWithExceptionsButton" class="btn btn-primary" onclick="ouRolesModalService.handleExceptedRoleAssignment()" th:text="#{html.page.ous.edit.button.assign.exceptedusers}"/>
					<div class="btn-group" id="titleInheritButton">
                        <button id="assignAllButton" type="button" style="margin-left: 5px;" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                        	<span>
								<span th:text="#{html.page.ous.edit.button.assign.intro}"/>&nbsp;
								<em class="fa fa-fw fa-caret-down"></em>
							</span>
                        </button>
						<ul class="dropdown-menu">
			    			<li><a href="#" onclick="ouRolesModalService.handleEveryoneRoleAssignment(false)" id="assignEveryoneChoiceDropdownForTestCases" th:text="#{html.page.ous.edit.button.assign.all}" /></li>
	                		<li><a href="#" onclick="ouRolesModalService.handleEveryoneRoleAssignment(true)" th:text="#{html.page.ous.edit.button.assign.all.inheritance}"/></li>
			  			</ul>
			  		</div>
					<button type="button" class="btn btn-danger" style="margin-left: 5px;" onclick="ouRolesModalService.handleRemoveRoleAssignment()" th:text="#{html.page.ous.edit.button.deassign}"/>
				</div>
			</div>
		</div>
	</div>
</th:block>
	
<th:block th:fragment="ouRoleGroupModalScript" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
	<script th:inline="javascript" type="text/javascript">
		/*<![CDATA[*/
		
		/*[+
		var titlesEnabled = [[${titlesEnabled}]];
		var urlModal = [[@{/rest/ous/}]];
		var restUserRoleUrl = [[@{/rest/userroles/}]]
		var fieldUpdatedMsg = [[#{html.entity.rolegroup.updatedmsg}]];
		var fieldNotUpdatedMsg = [[#{html.entity.rolegroup.failedupdatemsg}]];
		var urlOUsModal = [[@{/rest/ous/}]];
		var urlFetchExceptedUsers = [[@{/ui/ous/}]]
		+]*/
		var payload = {
				roleType: '',
				roleId: 0,
				checkboxRef: null,
				ouUuid: ''
		};
		var ouRolesModalService
		var notifikationService;
		var titles = [];
		var checkedTitlesFetched;
		$(document).ready(function() {
            ouRolesModalService = new OURolesModalService();
            ouRolesModalService.init();
            
            notifikationService = new NotificationService();
        });
		
		function OURolesModalService(){
			this.init = function(){
				$('#modal-ou').on('shown.bs.modal', function (e) {
					// Add checkboxlisteners to modal
					ouRolesModalService.addTitleCheckboxListeners();
					ouRolesModalService.addExceptedUsersCheckboxListeners();

					// Show tab with prefilled information
					if ($('.title-checkbox:checked').length > 0) {
						$('.nav-tabs a[href="#ou_roles_title_menu"]').tab('show');
					}
					else if ($('.exceptedusers-checkbox:checked').length > 0) {
						$('.nav-tabs a[href="#ou_roles_excepted_users_menu"]').tab('show');
					}
				})


				// Add change tab event handler
				$('a[data-toggle="tab"]').on("shown.bs.tab", function (e) {
					// Fetch active tab and show/hide buttons depending on that
					var tabType = $('#modal-ou .nav-tabs li.active a[data-toggle="tab"]').data('tab-type');

					if (tabType == 'ou_roles_title_menu') {
						$("#titleAssignTitlesButton").show();
						$("#assignWithExceptionsButton").hide();

						ouRolesModalService.handleTitleCheckbox();
					} 
					else if (tabType == 'ou_roles_excepted_users_menu') {
						$("#titleAssignTitlesButton").hide();
						$("#assignWithExceptionsButton").show();

						ouRolesModalService.handleExceptedUsersCheckbox();
					}
				});
			}
			
			this.loadTitles = function(loadCheckedTitles) {
				var endpoint = restUserRoleUrl + 'titles/' + payload.ouUuid;
				$.ajax({
					url: endpoint,
					method: "GET",
					error: function(response) {
						showErrorNotification(fieldNotUpdatedMsg);
					},
					success : function(response) {
						titles=response;
						if (loadCheckedTitles) {
							ouRolesModalService.fetchCheckedTitles(response);
						}
					}
				});
			}
			
			this.fetchCheckedTitles = function(titles) {
				//fetch checked titles
				$.ajax({
					url: urlOUsModal + payload.ouUuid + "/" + payload.roleType + "/" + payload.roleId + "/titles", 
					method: "POST",
					headers: {
						'X-CSRF-TOKEN': token
					},
	                contentType: 'application/json',
					data: JSON.stringify(titles),
					error : function(response) {
						notificationService.showErrorNotification(fieldNotUpdatedMsg);
						payload.checkboxRef.checked = !payload.checkboxRef.checked;
					},
					success : function(response) {
						checkedTitlesFetched=response;
					}
				});
			}
			
			this.addTitleCheckboxListeners = function(){
				// makes sure the title checkboxes on the modal dialogue modifies the underlying datastructure on changes
				$('.title-checkbox').off("change");
				$('.title-checkbox').change(ouRolesModalService.handleTitleCheckbox);
			}

			this.addExceptedUsersCheckboxListeners = function() {
				$('.exceptedusers-checkbox').off("change");
				$('.exceptedusers-checkbox').change(ouRolesModalService.handleExceptedUsersCheckbox);
			}
			
			this.showAssignModal = function(titlesEnabled, checked, checkedTitles, startDate, stopDate) {
				// Setup DatePickers
				if (stopDate) {
					$('#stopDatePickerOU').data("DateTimePicker").date(stopDate);
				} else {
					$('#stopDatePickerOU').data("DateTimePicker").clear();
				}

				if (startDate) {
					$('#startDatePickerOU').data("DateTimePicker").date(startDate);
				} else {
					$('#startDatePickerOU').data("DateTimePicker").clear();
					$('#startDatePickerOU').data("DateTimePicker").date(new Date());
				}

				// If titles are enabled, check all the checked boxes and disable/enable option to assign to titles.
				if (titlesEnabled) {
					var anythingChecked = false;
					
					// Check the boxes corrosponding to the list of checked titles from the backend
					if (checkedTitles != null){
						for (var i = 0; i < titles.length; i++) {
							titles[i].state.checked = (checkedTitles.indexOf(titles[i].id) > -1);
							$('.title-checkbox[data-id=' + titles[i].id + ']').prop('checked', titles[i].state.checked);
							
							if (titles[i].state.checked) {
								anythingChecked = true;
							}
						}
					}else if (checkedTitlesFetched){
						for (var i = 0; i < titles.length; i++) {
							titles[i].state.checked = (checkedTitlesFetched != null && checkedTitlesFetched.indexOf(titles[i].id) > -1);
							$('.title-checkbox[data-id=' + titles[i].id + ']').prop('checked', titles[i].state.checked);
							
							if (titles[i].state.checked) {
								anythingChecked = true;
							}
						}
					}
					
					// Show assign to titles button and enable/disable it based on number of checked titles
					$("#titleAssignTitlesButton").show();
					if (!anythingChecked) {
						$("#titleAssignTitlesButton").prop('disabled', true);
						$("#assignAllButton").prop('disabled', false);
					}
					else {
						$("#titleAssignTitlesButton").prop('disabled', false);
						$("#assignAllButton").prop('disabled', true);
					}

					$('a[data-toggle="tab"][href="#ou_roles_title_menu"]').tab('show');
				}
				else {
					// If titles not enabled, hide assign to tiles button
					$('a[data-toggle="tab"][href="#ou_roles_excepted_users_menu"]').tab('show');
					$("#titleAssignTitlesButton").hide();
				}

				// Fetch excepted users (if any), and check checkboxes
				var url = urlFetchExceptedUsers + payload.roleType + "/exceptedusers/" + payload.ouUuid + "/" + payload.roleId;
				$("#ou_roles_excepted_users_menu").load(url, function() {
					fragShowDataTableFun('#ou_roles_listTable2', 0);
				});

				$("#titleInheritButton").show();

				$("#modal-ou").modal({
					backdrop: 'static',
					keyboard: false
				});
			}
			
			this.assignRole = function(objType, inherit, id, titleUuids, exceptedUserUuids) {
				var endpoint = urlModal + 'add' + objType + '/' + payload.ouUuid + '/' + id;

				var startDate = $('#startDatePickerOU').data('date');
				var stopDate = $('#stopDatePickerOU').data('date');
				var dates = "?startDate=" + startDate + "&stopDate=" + stopDate;
				endpoint = endpoint + dates;
				
				if (inherit) {
					endpoint = endpoint + "&inherit=true";
				}
				
				$.ajax({
					url: endpoint,
					method: "POST",
					headers: {
						'X-CSRF-TOKEN': token
					},
	                contentType: 'application/json',
	                data: JSON.stringify({
	    			      'titleUuids': titleUuids,
	    			      'exceptedUserUuids' : exceptedUserUuids
					}),
					error : function(response) {
						notifikationService.showErrorNotification(fieldNotUpdatedMsg);
						ouRolesModalService.closeModalWithState(false);
					},
					success : function(response) {
						if (response.success) {
							if (response.users > 0) {
								var optionalSuccessMessage = usersAlreadyAssignedDirectlyMsg.format(response.users);
								notifikationService.showWarnNotification(optionalSuccessMessage);
							}
							else {
								notifikationService.showInfoNotification(fieldUpdatedMsg);
							}
						}
						else {
							// TODO: should we inform the user that we did not make any change?
							notifikationService.showInfoNotification(fieldUpdatedMsg);
						}
						
						ouRolesModalService.closeModalWithState(true);
					}
				});
				
				// TODO: I doubt this works with failures
				// TODO: what to do with this? should not be in fragment. Belongs to ous/edit.html
				//updateCheckboxSorting(objType, id, true);
			}
			
			this.deassignRole = function(objType, id) {
				var endpoint = urlModal + 'remove' + objType + '/' + payload.ouUuid + '/' + id;

				$.ajax({
					url: endpoint,
					method: "POST",
					headers: {
						'X-CSRF-TOKEN': token
					},
					error : function(response) {
						notifikationService.showErrorNotification(fieldNotUpdatedMsg);
						ouRolesModalService.closeModalWithState(true);
					},
					success : function(response) {
						notifikationService.showInfoNotification(fieldUpdatedMsg);
						ouRolesModalService.closeModalWithState(false);
					}
				});
				
				// TODO: I doubt this works with failures
				// TODO: what to do with this? should not be in fragment. Belongs to ous/edit.html
				//updateCheckboxSorting(objType, id, false);
			}
			
			// wrapper around assignRole that gets the list of selected excepted users
			this.handleExceptedRoleAssignment = function() {
				var exceptedUsers = [];
				var exceptedUsersChbx = $('.exceptedusers-checkbox:checked');
				for (var i = 0; i < exceptedUsersChbx.length; i++) {
					exceptedUsers.push($(exceptedUsersChbx[i]).data('id'));
				}
				
				ouRolesModalService.assignRole(payload.roleType, false, payload.roleId, [], exceptedUsers);
			}

			// wrapper around assignRole that reads the list of checked title UUIDs called by button click
			this.handleTitleRoleAssignment = function() {
				var titleUuids = [];
				for (var i = 0; i < titles.length; i++) {
					if (titles[i].state.checked) {
						titleUuids.push(titles[i].id);
					}
				}
				
				ouRolesModalService.assignRole(payload.roleType, false, payload.roleId, titleUuids, []);
			}
			
			// wrapper around assignRole that assigns to everyone called by button click
			this.handleEveryoneRoleAssignment = function(inherit) {
				ouRolesModalService.assignRole(payload.roleType, inherit, payload.roleId, [], []);			
			}

			// wrapper around deassignRole called by button click
			this.handleRemoveRoleAssignment = function() {
				ouRolesModalService.deassignRole(payload.roleType, payload.roleId);
			}
			
			this.closeModalWithState = function(checkboxState) {
				payload.checkboxRef.checked = checkboxState;

				// Set data-startdate and data-stopdate so you don't have to refresh to have the values
				$(payload.checkboxRef).attr('data-startdate', $('#startDatePickerOU').data('date'));
				$(payload.checkboxRef).attr('data-stopdate', $('#stopDatePickerOU').data('date'));

				$('#modal-ou').modal('toggle');
			}
			
			this.closeModal = function() {
				payload.checkboxRef.checked = !payload.checkboxRef.checked;

				$('#modal-ou').modal('toggle');
			}
			
			this.handleTitleCheckbox = function() {
				var anythingChecked = false;

				for (var i = 0; i < titles.length; i++) {
					if (titles[i].id == $(this).data('id')) {
						titles[i].state.checked = this.checked;					
					}
					
					if (titles[i].state.checked) {
						anythingChecked = true;
					}
				}
				
				if (!anythingChecked) {
					$("#titleAssignTitlesButton").prop('disabled', true);
					$("#assignAllButton").prop('disabled', false);
				}
				else {
					$("#titleAssignTitlesButton").prop('disabled', false);
					$("#assignAllButton").prop('disabled', true);
				}
			}

			this.handleExceptedUsersCheckbox = function() {
				var anythingChecked = $('.exceptedusers-checkbox:checked').length > 0;
				
				if (!anythingChecked) {
					$("#assignWithExceptionsButton").prop('disabled', true);
					$("#assignAllButton").prop('disabled', false);
				}
				else {
					$("#assignWithExceptionsButton").prop('disabled', false);
					$("#assignAllButton").prop('disabled', true);
				}
			}
		}
		
		function NotificationService() {
			this.showInfoNotification = function(message) {
				$.notify({
					message: message,
					status: 'success',
					timeout: 2000
				});
			}
			
			this.showWarnNotification = function(message) {
				$.notify({
					message: message,
					status: 'warning',
					timeout: 3000
				});
			}

			this.showErrorNotification = function(message) {
				$.notify({
					message: message,
					status: 'danger',
					timeout: 4000
				});
			}
		}
	
		
		
		/*]]>*/

	</script>
</th:block>